!function(){var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function n(e,t){var n,i,o,s,r,a,c,u,l,d,f=t&&t.split("/"),h=p.map,_=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(f=f.slice(0,f.length-1),e=f.concat(e.split("/")),u=0;u<e.length;u+=1)if(d=e[u],"."===d)e.splice(u,1),u-=1;else if(".."===d){if(1===u&&(".."===e[2]||".."===e[0]))break;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((f||_)&&h){for(n=e.split("/"),u=n.length;u>0;u-=1){if(i=n.slice(0,u).join("/"),f)for(l=f.length;l>0;l-=1)if(o=h[f.slice(0,l).join("/")],o&&(o=o[i])){s=o,r=u;break}if(s)break;!a&&_&&_[i]&&(a=_[i],c=u)}!s&&a&&(s=a,r=c),s&&(n.splice(0,r,s),e=n.join("/"))}return e}function i(t,n){return function(){return l.apply(e,y.call(arguments,0).concat([t,n]))}}function o(e){return function(t){return n(t,e)}}function s(e){return function(t){h[e]=t}}function r(n){if(t(_,n)){var i=_[n];delete _[n],m[n]=!0,u.apply(e,i)}if(!t(h,n)&&!t(m,n))throw new Error("No "+n);return h[n]}function a(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function c(e){return function(){return p&&p.config&&p.config[e]||{}}}var u,l,d,f,h={},_={},p={},m={},v=Object.prototype.hasOwnProperty,y=[].slice;d=function(e,t){var i,s=a(e),c=s[0];return e=s[1],c&&(c=n(c,t),i=r(c)),c?e=i&&i.normalize?i.normalize(e,o(t)):n(e,t):(e=n(e,t),s=a(e),c=s[0],e=s[1],c&&(i=r(c))),{f:c?c+"!"+e:e,n:e,pr:c,p:i}},f={require:function(e){return i(e)},exports:function(e){var t=h[e];return"undefined"!=typeof t?t:h[e]={}},module:function(e){return{id:e,uri:"",exports:h[e],config:c(e)}}},u=function(n,o,a,c){var u,l,p,v,y,b,g=[];if(c=c||n,"function"==typeof a){for(o=!o.length&&a.length?["require","exports","module"]:o,y=0;y<o.length;y+=1)if(v=d(o[y],c),l=v.f,"require"===l)g[y]=f.require(n);else if("exports"===l)g[y]=f.exports(n),b=!0;else if("module"===l)u=g[y]=f.module(n);else if(t(h,l)||t(_,l)||t(m,l))g[y]=r(l);else{if(!v.p)throw new Error(n+" missing "+l);v.p.load(v.n,i(c,!0),s(l),{}),g[y]=h[l]}p=a.apply(h[n],g),n&&(u&&u.exports!==e&&u.exports!==h[n]?h[n]=u.exports:p===e&&b||(h[n]=p))}else n&&(h[n]=a)},requirejs=require=l=function(t,n,i,o,s){return"string"==typeof t?f[t]?f[t](n):r(d(t,n).f):(t.splice||(p=t,n.splice?(t=n,n=i,i=null):t=e),n=n||function(){},"function"==typeof i&&(i=o,o=s),o?u(e,t,n,i):setTimeout(function(){u(e,t,n,i)},4),l)},l.config=function(e){return p=e,p.deps&&l(p.deps,p.callback),l},requirejs._defined=h,define=function(e,n,i){n.splice||(i=n,n=[]),t(h,e)||t(_,e)||(_[e]=[e,n,i])},define.amd={jQuery:!0}}(),define("almond",function(){}),define("event",[],function(){function e(){this.init()}return e.prototype={listeners:null,init:function(){this.listeners=[]},addListener:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},removeListener:function(e,t){if(!this.listeners[e])return!1;for(var n=0;n<this.listeners[e].length;n++)if(this.listeners[e][n]==t)return this.listeners[e]=this.listeners[e].splice(n,1),!0},trigger:function(e,t){function n(e){setTimeout(function(){e(t)},0)}if(!this.listeners[e])return!1;for(var i=0;i<this.listeners[e].length;i++)n(this.listeners[e][i]);return!0}},new e}),define("globals",[],function(){return{isiOS:function(){return this.hasDeviceType("iOS")},isPC:function(){return this.hasDeviceType("PC")},isMac:function(){return this.hasDeviceType("Mac")},hasDeviceType:function(e){return-1!==this.getDeviceType().indexOf(e)},getDeviceType:function(){localStorage.deviceType;var e=[],t=navigator.userAgent;return t.match(/OS 7/g)?(e.push("iOS"),t.match(/iPad/g)?(e.push("iPad"),e.push("tablet")):t.match(/iPhone/g)&&(e.push("iPhone"),e.push("phone"))):t.match(/Mac/g)?(e.push("Mac"),e.push("computer")):(e.push("PC"),e.push("computer")),localStorage.deviceType=JSON.stringify(e),e},setHTMLDevices:function(){var e=this.getDeviceType(),t=document.body;t.className=e.join(" ")}}}),define("class",[],function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;return this.Class=function(){},Class.extend=function(n){function i(){!e&&this.init&&this.init.apply(this,arguments)}var o=this.prototype;e=!0;var s=new this;e=!1;for(var r in n)s[r]="function"==typeof n[r]&&"function"==typeof o[r]&&t.test(n[r])?function(e,t){return function(){var n=this._super;this._super=o[e];var i=t.apply(this,arguments);return this._super=n,i}}(r,n[r]):n[r];return i.prototype=s,i.prototype.constructor=i,i.extend=arguments.callee,i},this.Class}),define("section",["class"],function(e){var t=e.extend({id:null,element:null,init:function(){this.element=document.getElementById(this.id)},show:null,hide:null,afterShow:function(){this.element.style.display="block"},afterHide:function(){this.element.style.display=""}});return t}),define("tapHandler",[],function(){function e(e,t){this.init(e,t)}return e.prototype={_element:null,_options:null,_distCutoff:20,_timeCutoff:500,_startTime:null,_startX:null,_startY:null,_startScale:null,_lastX:null,_lastY:null,_lastScale:null,_offset:null,_inTouch:!1,_inGesture:!1,init:function(e,t){this._element=e,this._options=t,this._move=this._move.bind(this),this._end=this._end.bind(this),this._gestureChange=this._gestureChange.bind(this),this._gestureEnd=this._gestureEnd.bind(this),this._offset={x:e.offsetLeft,y:e.offsetTop},this._element.addEventListener("mousedown",this._start.bind(this)),this._element.addEventListener("touchstart",this._start.bind(this)),this._element.addEventListener("gesturestart",this._gestureStart.bind(this))},_start:function(e){this._inGesture||(this._inTouch=!0,this._processEvent(e),this._startTime=e.timeStamp,this._startX=this._lastX=e.x,this._startY=this._lastY=e.y,this._options.start&&this._options.start(e),document.addEventListener("touchmove",this._move),document.addEventListener("mousemove",this._move),document.addEventListener("touchend",this._end),document.addEventListener("mouseup",this._end))},_move:function(e){this._processEvent(e),this._lastX=e.x,this._lastY=e.y,this._options.move&&this._options.move(e)},_end:function(e){if(this._endTouchHandlers(),e){this._processEvent(e);var t=Math.sqrt((e.x-this._startX)*(e.x-this._startX)+(e.y-this._startY)*(e.y-this._startY));t<this._distCutoff&&e.timeStamp-this._startTime<this._timeCutoff&&this._options.tap&&this._options.tap(e)}this._options.end&&this._options.end(e),this._inTouch=!1},_gestureStart:function(e){this._inGesture=!0,this._end(),this._processEvent(e),this._processGesture(e),this._startTime=e.timeStamp,this._startX=this._lastX=e.x,this._startY=this._lastY=e.y,this._startScale=this._lastScale=e.scale,document.addEventListener("gesturechange",this._gestureChange),document.addEventListener("gestureend",this._gestureEnd)},_gestureChange:function(e){this._processEvent(e),this._processGesture(e),this._lastX=e.x,this._lastY=e.y,this._lastScale=e.scale,this._lastScale=e.scale,this._options.gesture&&this._options.gesture(e)},_gestureEnd:function(e){this._processEvent(e),this._processGesture(e),document.removeEventListener("gesturechange",this._gestureChange),document.removeEventListener("gestureend",this._gestureEnd),this._inGesture=!1},_endTouchHandlers:function(){document.removeEventListener("touchmove",this._move),document.removeEventListener("mousemove",this._move),document.removeEventListener("touchend",this._end),document.removeEventListener("mouseup",this._end)},_processEvent:function(e){e.touches&&e.touches.length>0?(e.x=e.touches[0].clientX,e.y=e.touches[0].clientY):e.clientX?(e.x=e.clientX,e.y=e.clientY):e.pageX?(e.x=e.pageX,e.y=e.pageY):(e.x=this._lastX,e.y=this._lastY),e.distFromLeft=e.x-this._offset.x,e.distFromTop=e.y-this._offset.y,e.xFromLast=e.x-this._lastX,e.yFromLast=e.y-this._lastY},_processGesture:function(e){e.scaleFromLast=e.scale-this._lastScale}},e}),define("sections/login",["event","section","tapHandler"],function(e,t,n){var i=t.extend({id:"login",init:function(){this._super(),console.log("login init");var e=document.getElementById("loginbutton");new n(e,{tap:this._loginClicked.bind(this)})},_loginClicked:function(){setTimeout(function(){e.trigger("login")},400)},show:function(){console.log("login shown")},hide:function(){console.log("login hidden")}});return i}),define("helpers",[],function(){return{parentEleWithClassname:function(e,t){return null!=e&&e.classList?e.classList.contains(t)?e:this.parentEleWithClassname(e.parentNode,t):!1},screenToWorld:function(e,t,n){return{x:(t-e.offsetX)/e.scale,y:(n-e.offsetY)/e.scale}},worldToScreen:function(e,t,n){return{x:t*e.scale+e.offsetX,y:n*e.scale+e.offsetY}},getCurveControlPoints:function(e){function t(e){var t=e.length,n=new Array(t),i=new Array(t),o=2;n[0]=e[0]/o;for(var s=1;t>s;s++)i[s]=1/o,o=(t-1>s?4:3.5)-i[s],n[s]=(e[s]-n[s-1])/o;for(var s=1;t>s;s++)n[t-s-1]-=i[t-s]*n[t-s];return n}var n=e.length-1,i=[],o=[];if(1>n)return console.error("Must have at least two knots"),void 0;if(1==n)return i.push({}),i[0].x=(2*e[0].x+e[1].x)/3,i[0].y=(2*e[0].y+e[1].y)/3,o.push({}),o[0].x=2*i[0].x-e[0].x,o[0].y=2*i[0].y-e[0].y,[{first:i[0],second:o[0]}];for(var s=new Array(n),r=1;n-1>r;++r)s[r]=4*e[r].x+2*e[r+1].x;s[0]=e[0].x+2*e[1].x,s[n-1]=(8*e[n-1].x+e[n].x)/2;for(var a=t(s),r=1;n-1>r;++r)s[r]=4*e[r].y+2*e[r+1].y;s[0]=e[0].y+2*e[1].y,s[n-1]=(8*e[n-1].y+e[n].y)/2;var c=t(s);i=new Array(n),o=new Array(n);for(var r=0;n>r;++r)i[r]={x:a[r],y:c[r]},o[r]=n-1>r?{x:2*e[r+1].x-a[r+1],y:2*e[r+1].y-c[r+1]}:{x:(e[n].x+a[n-1])/2,y:(e[n].y+c[n-1])/2};for(var u=new Array(n),r=0;n>r;++r)u[r]={first:i[r],second:o[r]};return u}}});var idbModules={};!function(e){function t(e,t,n,i){n.target=t,"function"==typeof t[e]&&t[e].apply(t,[n]),"function"==typeof i&&i()}function n(t,n,i){var o=new DOMException.constructor(0,n);throw o.name=t,o.message=n,e.DEBUG&&(console.log(t,n,i,o),console.trace&&console.trace()),o}var i=function(){this.length=0,this._items=[],Object.defineProperty&&Object.defineProperty(this,"_items",{enumerable:!1})};if(i.prototype={contains:function(e){return-1!==this._items.indexOf(e)},item:function(e){return this._items[e]},indexOf:function(e){return this._items.indexOf(e)},push:function(e){this._items.push(e),this.length+=1;for(var t=0;t<this._items.length;t++)this[t]=this._items[t]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var e in this)e===String(parseInt(e,10))&&delete this[e];for(e=0;e<this._items.length;e++)this[e]=this._items[e]}},Object.defineProperty)for(var o in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(i.prototype,o,{enumerable:!1});e.util={throwDOMException:n,callback:t,quote:function(e){return"'"+e+"'"},StringList:i}}(idbModules),function(idbModules){var Sca=function(){return{decycle:function(object,callback){function checkForCompletion(){0===queuedObjects.length&&returnCallback(derezObj)}function readBlobAsDataURL(e,t){var n=new FileReader;n.onloadend=function(e){var n=e.target.result,i="blob";updateEncodedBlob(n,t,i)},n.readAsDataURL(e)}function updateEncodedBlob(dataURL,path,blobtype){var encoded=queuedObjects.indexOf(path);path=path.replace("$","derezObj"),eval(path+'.$enc="'+dataURL+'"'),eval(path+'.$type="'+blobtype+'"'),queuedObjects.splice(encoded,1),checkForCompletion()}function derez(e,t){var n,i,o;if(!("object"!=typeof e||null===e||e instanceof Boolean||e instanceof Date||e instanceof Number||e instanceof RegExp||e instanceof Blob||e instanceof String)){for(n=0;n<objects.length;n+=1)if(objects[n]===e)return{$ref:paths[n]};if(objects.push(e),paths.push(t),"[object Array]"===Object.prototype.toString.apply(e))for(o=[],n=0;n<e.length;n+=1)o[n]=derez(e[n],t+"["+n+"]");else{o={};for(i in e)Object.prototype.hasOwnProperty.call(e,i)&&(o[i]=derez(e[i],t+"["+JSON.stringify(i)+"]"))}return o}return e instanceof Blob?(queuedObjects.push(t),readBlobAsDataURL(e,t)):e instanceof Boolean?e={$type:"bool",$enc:e.toString()}:e instanceof Date?e={$type:"date",$enc:e.getTime()}:e instanceof Number?e={$type:"num",$enc:e.toString()}:e instanceof RegExp&&(e={$type:"regex",$enc:e.toString()}),e}var objects=[],paths=[],queuedObjects=[],returnCallback=callback,derezObj=derez(object,"$");checkForCompletion()},retrocycle:function retrocycle($){function dataURLToBlob(e){var t,n,i,o=";base64,";if(-1===e.indexOf(o))return n=e.split(","),t=n[0].split(":")[1],i=n[1],new Blob([i],{type:t});n=e.split(o),t=n[0].split(":")[1],i=window.atob(n[1]);for(var s=i.length,r=new Uint8Array(s),a=0;s>a;++a)r[a]=i.charCodeAt(a);return new Blob([r.buffer],{type:t})}function rez(value){var i,item,name,path;if(value&&"object"==typeof value)if("[object Array]"===Object.prototype.toString.apply(value))for(i=0;i<value.length;i+=1)item=value[i],item&&"object"==typeof item&&(path=item.$ref,value[i]="string"==typeof path&&px.test(path)?eval(path):rez(item));else if(void 0!==value.$type)switch(value.$type){case"blob":case"file":value=dataURLToBlob(value.$enc);break;case"bool":value=Boolean("true"===value.$enc);break;case"date":value=new Date(value.$enc);break;case"num":value=Number(value.$enc);break;case"regex":value=eval(value.$enc)}else for(name in value)"object"==typeof value[name]&&(item=value[name],item&&(path=item.$ref,value[name]="string"==typeof path&&px.test(path)?eval(path):rez(item)));return value}var px=/^\$(?:\[(?:\d+|\"(?:[^\\\"\u0000-\u001f]|\\([\\\"\/bfnrt]|u[0-9a-zA-Z]{4}))*\")\])*$/;return rez($),$},encode:function(e,t){function n(e){t(JSON.stringify(e))}this.decycle(e,n)},decode:function(e){return this.retrocycle(JSON.parse(e))}}}();idbModules.Sca=Sca}(idbModules),function(e){var t=["","number","string","boolean","object","undefined"],n=function(){return{encode:function(e){return t.indexOf(typeof e)+"-"+JSON.stringify(e)},decode:function(e){return"undefined"==typeof e?void 0:JSON.parse(e.substring(2))}}},i={number:n("number"),"boolean":n(),object:n(),string:{encode:function(e){return t.indexOf("string")+"-"+e},decode:function(e){return""+e.substring(2)}},undefined:{encode:function(){return t.indexOf("undefined")+"-undefined"},decode:function(){return void 0}}},o=function(){return{encode:function(e){return i[typeof e].encode(e)},decode:function(e){return i[t[e.substring(0,1)]].decode(e)}}}();e.Key=o}(idbModules),function(e){var t=function(e,t){return{type:e,debug:t,bubbles:!1,cancelable:!1,eventPhase:0,timeStamp:new Date}};e.Event=t}(idbModules),function(e){var t=function(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"},n=function(){this.onblocked=this.onupgradeneeded=null};n.prototype=t,e.IDBRequest=t,e.IDBOpenRequest=n}(idbModules),function(e,t){var n=function(e,t,n,i){this.lower=e,this.upper=t,this.lowerOpen=n,this.upperOpen=i};n.only=function(e){return new n(e,e,!1,!1)},n.lowerBound=function(e,i){return new n(e,t,i,t)},n.upperBound=function(e){return new n(t,e,t,open)},n.bound=function(e,t,i,o){return new n(e,t,i,o)},e.IDBKeyRange=n}(idbModules),function(e,t){function n(n,i,o,s,r,a){this.__range=n,this.source=this.__idbObjectStore=o,this.__req=s,this.key=t,this.direction=i,this.__keyColumnName=r,this.__valueColumnName=a,this.source.transaction.__active||e.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active."),this.__offset=-1,this.__lastKeyContinued=t,this["continue"]()}n.prototype.__find=function(n,i,o,s){var r=this,a=["SELECT * FROM ",e.util.quote(r.__idbObjectStore.name)],c=[];a.push("WHERE ",r.__keyColumnName," NOT NULL"),r.__range&&(r.__range.lower||r.__range.upper)&&(a.push("AND"),r.__range.lower&&(a.push(r.__keyColumnName+(r.__range.lowerOpen?" >":" >= ")+" ?"),c.push(e.Key.encode(r.__range.lower))),r.__range.lower&&r.__range.upper&&a.push("AND"),r.__range.upper&&(a.push(r.__keyColumnName+(r.__range.upperOpen?" < ":" <= ")+" ?"),c.push(e.Key.encode(r.__range.upper)))),"undefined"!=typeof n&&(r.__lastKeyContinued=n,r.__offset=0),r.__lastKeyContinued!==t&&(a.push("AND "+r.__keyColumnName+" >= ?"),c.push(e.Key.encode(r.__lastKeyContinued))),a.push("ORDER BY ",r.__keyColumnName),a.push("LIMIT 1 OFFSET "+r.__offset),e.DEBUG&&console.log(a.join(" "),c),i.executeSql(a.join(" "),c,function(n,i){if(1===i.rows.length){var s=e.Key.decode(i.rows.item(0)[r.__keyColumnName]),a="value"===r.__valueColumnName?e.Sca.decode(i.rows.item(0)[r.__valueColumnName]):e.Key.decode(i.rows.item(0)[r.__valueColumnName]);o(s,a)}else e.DEBUG&&console.log("Reached end of cursors"),o(t,t)},function(t,n){e.DEBUG&&console.log("Could not execute Cursor.continue"),s(n)})},n.prototype["continue"]=function(e){var n=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(i,o,s,r){n.__offset++,n.__find(e,i,function(e,i){n.key=e,n.value=i,s("undefined"!=typeof n.key?n:t,n.__req)},function(e){r(e)})})},n.prototype.advance=function(n){0>=n&&e.util.throwDOMException("Type Error - Count is invalid - 0 or negative",n);var i=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(e,o,s,r){i.__offset+=n,i.__find(t,e,function(e,n){i.key=e,i.value=n,s("undefined"!=typeof i.key?i:t,i.__req)},function(e){r(e)})})},n.prototype.update=function(n){var i=this,o=this.__idbObjectStore.transaction.__createRequest(function(){});return e.Sca.encode(n,function(n){this.__idbObjectStore.__pushToQueue(o,function(o,s,r,a){i.__find(t,o,function(t){var s="UPDATE "+e.util.quote(i.__idbObjectStore.name)+" SET value = ? WHERE key = ?";e.DEBUG&&console.log(s,n,t),o.executeSql(s,[e.Sca.encode(n),e.Key.encode(t)],function(e,n){1===n.rowsAffected?r(t):a("No rowns with key found"+t)},function(e,t){a(t)})},function(e){a(e)})})}),o},n.prototype["delete"]=function(){var n=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(i,o,s,r){n.__find(t,i,function(o){var a="DELETE FROM  "+e.util.quote(n.__idbObjectStore.name)+" WHERE key = ?";e.DEBUG&&console.log(a,o),i.executeSql(a,[e.Key.encode(o)],function(e,n){1===n.rowsAffected?s(t):r("No rowns with key found"+o)},function(e,t){r(t)})},function(e){r(e)})})},e.IDBCursor=n}(idbModules),function(idbModules,undefined){function IDBIndex(e,t){this.indexName=this.name=e,this.__idbObjectStore=this.objectStore=this.source=t;var n=t.__storeProps&&t.__storeProps.indexList;n&&(n=JSON.parse(n)),this.keyPath=n&&n[e]&&n[e].keyPath||e,["multiEntry","unique"].forEach(function(t){this[t]=!!(n&&n[e]&&n[e].optionalParams&&n[e].optionalParams[t])},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this,transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(){idbModules.util.throwDOMException(0,"Could not create new index",arguments)}2!==transaction.mode&&idbModules.util.throwDOMException(0,"Invalid State error, not a version transaction",me.transaction);var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);"undefined"!=typeof idxList[indexName]&&idbModules.util.throwDOMException(0,"Index already exists on store",idxList);var columnName=indexName;idxList[indexName]={columnName:columnName,keyPath:keyPath,optionalParams:optionalParameters},me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",columnName,"BLOB"].join(" ");idbModules.DEBUG&&console.log(sql),tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){!function initIndexForRow(i){if(i<data.rows.length)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+columnName+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else idbModules.DEBUG&&console.log("Updating the indexes in table",me.__idbObjectStore.__storeProps),tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",!0),success(me)},error)}(0)},error)},error)},"createObjectStore")})},IDBIndex.prototype.openCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this.source,n,this.indexName,"value"),n},IDBIndex.prototype.openKeyCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this.source,n,this.indexName,"key"),n},IDBIndex.prototype.__fetchIndexData=function(e,t){var n=this;return n.__idbObjectStore.transaction.__addToTransactionQueue(function(i,o,s,r){var a=["SELECT * FROM ",idbModules.util.quote(n.__idbObjectStore.name)," WHERE",n.indexName,"NOT NULL"],c=[];"undefined"!=typeof e&&(a.push("AND",n.indexName," = ?"),c.push(idbModules.Key.encode(e))),idbModules.DEBUG&&console.log("Trying to fetch data for Index",a.join(" "),c),i.executeSql(a.join(" "),c,function(e,n){var i;i="count"==typeof t?n.rows.length:0===n.rows.length?undefined:"key"===t?idbModules.Key.decode(n.rows.item(0).key):idbModules.Sca.decode(n.rows.item(0).value),s(i)},r)})},IDBIndex.prototype.get=function(e){return this.__fetchIndexData(e,"value")},IDBIndex.prototype.getKey=function(e){return this.__fetchIndexData(e,"key")},IDBIndex.prototype.count=function(e){return this.__fetchIndexData(e,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){var IDBObjectStore=function(e,t,n){this.name=e,this.transaction=t,this.__ready={},this.__setReadyState("createObjectStore","undefined"==typeof n?!0:n),this.indexNames=new idbModules.util.StringList};IDBObjectStore.prototype.__setReadyState=function(e,t){this.__ready[e]=t},IDBObjectStore.prototype.__waitForReady=function(e,t){var n=!0;if("undefined"!=typeof t)n="undefined"==typeof this.__ready[t]?!0:this.__ready[t];else for(var i in this.__ready)this.__ready[i]||(n=!1);if(n)e();else{idbModules.DEBUG&&console.log("Waiting for to be ready",t);var o=this;window.setTimeout(function(){o.__waitForReady(e,t)},100)}},IDBObjectStore.prototype.__getStoreProps=function(e,t,n){var i=this;this.__waitForReady(function(){i.__storeProps?(idbModules.DEBUG&&console.log("Store properties - cached",i.__storeProps),t(i.__storeProps)):e.executeSql("SELECT * FROM __sys__ where name = ?",[i.name],function(e,n){1!==n.rows.length?t():(i.__storeProps={name:n.rows.item(0).name,indexList:n.rows.item(0).indexList,autoInc:n.rows.item(0).autoInc,keyPath:n.rows.item(0).keyPath},idbModules.DEBUG&&console.log("Store properties",i.__storeProps),t(i.__storeProps))},function(){t()})},n)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(e,t){1!==t.rows.length?callback(0):callback(t.rows.item(0).seq)},function(e,t){idbModules.util.throwDOMException(0,"Data Error - Could not get the auto increment value for key",t)})}var me=this;me.__getStoreProps(tx,function(props){if(props||idbModules.util.throwDOMException(0,"Data Error - Could not locate defination for this table",props),props.keyPath)if("undefined"!=typeof key&&idbModules.util.throwDOMException(0,"Data Error - The object store uses in-line keys and the key parameter was provided",props),value)try{var primaryKey=eval("value['"+props.keyPath+"']");primaryKey?callback(primaryKey):"true"===props.autoInc?getNextAutoIncKey():idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath")}catch(e){idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath",e)}else idbModules.util.throwDOMException(0,"Data Error - KeyPath was specified, but value was not");else"undefined"!=typeof key?callback(key):"false"===props.autoInc?idbModules.util.throwDOMException(0,"Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props):getNextAutoIncKey()})},IDBObjectStore.prototype.__insertData=function(tx,value,primaryKey,success,error){var paramMap={};"undefined"!=typeof primaryKey&&(paramMap.key=idbModules.Key.encode(primaryKey));var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes)try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(key in paramMap)sqlStart.push(key+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(value);var sql=sqlStart.join(" ")+sqlEnd.join(" ");idbModules.DEBUG&&console.log("SQL for adding",sql,sqlValues),tx.executeSql(sql,sqlValues,function(){success(primaryKey)},function(e,t){error(t)})},IDBObjectStore.prototype.add=function(e,t){var n=this,i=n.transaction.__createRequest(function(){});return idbModules.Sca.encode(e,function(o){n.transaction.__pushToQueue(i,function(i,s,r,a){n.__deriveKey(i,e,t,function(e){n.__insertData(i,o,e,r,a)})})}),i},IDBObjectStore.prototype.put=function(e,t){var n=this,i=n.transaction.__createRequest(function(){});return idbModules.Sca.encode(e,function(o){n.transaction.__pushToQueue(i,function(i,s,r,a){n.__deriveKey(i,e,t,function(e){var t="DELETE FROM "+idbModules.util.quote(n.name)+" where key = ?";i.executeSql(t,[idbModules.Key.encode(e)],function(t,i){idbModules.DEBUG&&console.log("Did the row with the",e,"exist? ",i.rowsAffected),n.__insertData(t,o,e,r,a)},function(e,t){a(t)})})})}),i},IDBObjectStore.prototype.get=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,i,o,s){t.__waitForReady(function(){var i=idbModules.Key.encode(e);idbModules.DEBUG&&console.log("Fetching",t.name,i),n.executeSql("SELECT * FROM "+idbModules.util.quote(t.name)+" where key = ?",[i],function(e,t){idbModules.DEBUG&&console.log("Fetched data",t);try{if(0===t.rows.length)return o();o(idbModules.Sca.decode(t.rows.item(0).value))}catch(n){idbModules.DEBUG&&console.log(n),o(void 0)}},function(e,t){s(t)})})})},IDBObjectStore.prototype["delete"]=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,i,o,s){t.__waitForReady(function(){var i=idbModules.Key.encode(e);idbModules.DEBUG&&console.log("Fetching",t.name,i),n.executeSql("DELETE FROM "+idbModules.util.quote(t.name)+" where key = ?",[i],function(e,t){idbModules.DEBUG&&console.log("Deleted from database",t.rowsAffected),o()},function(e,t){s(t)})})})},IDBObjectStore.prototype.clear=function(){var e=this;return e.transaction.__addToTransactionQueue(function(t,n,i,o){e.__waitForReady(function(){t.executeSql("DELETE FROM "+idbModules.util.quote(e.name),[],function(e,t){idbModules.DEBUG&&console.log("Cleared all records from database",t.rowsAffected),i()},function(e,t){o(t)})})})},IDBObjectStore.prototype.count=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,i,o,s){t.__waitForReady(function(){var i="SELECT * FROM "+idbModules.util.quote(t.name)+("undefined"!=typeof e?" WHERE key = ?":""),r=[];"undefined"!=typeof e&&r.push(idbModules.Key.encode(e)),n.executeSql(i,r,function(e,t){o(t.rows.length)},function(e,t){s(t)})})})},IDBObjectStore.prototype.openCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this,n,"key","value"),n},IDBObjectStore.prototype.index=function(e){var t=new idbModules.IDBIndex(e,this);return t},IDBObjectStore.prototype.createIndex=function(e,t,n){var i=this;n=n||{},i.__setReadyState("createIndex",!1);var o=new idbModules.IDBIndex(e,i);return i.__waitForReady(function(){o.__createIndex(e,t,n)},"createObjectStore"),i.indexNames.push(e),o},IDBObjectStore.prototype.deleteIndex=function(e){var t=new idbModules.IDBIndex(e,this,!1);return t.__deleteIndex(e),t},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(e){var t=0,n=1,i=2,o=function(i,o,s){if("number"==typeof o)this.mode=o,2!==o&&e.DEBUG&&console.log("Mode should be a string, but was specified as ",o);else if("string"==typeof o)switch(o){case"readwrite":this.mode=n;break;case"readonly":this.mode=t;break;default:this.mode=t}this.storeNames="string"==typeof i?[i]:i;for(var r=0;r<this.storeNames.length;r++)s.objectStoreNames.contains(this.storeNames[r])||e.util.throwDOMException(0,"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",this.storeNames[r]);this.__active=!0,this.__running=!1,this.__requests=[],this.__aborted=!1,this.db=s,this.error=null,this.onabort=this.onerror=this.oncomplete=null};o.prototype.__executeRequests=function(){if(this.__running&&this.mode!==i)return e.DEBUG&&console.log("Looks like the request set is already running",this.mode),void 0;this.__running=!0;var t=this;window.setTimeout(function(){2===t.mode||t.__active||e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",t.__active),t.db.__db.transaction(function(n){function i(t,n){n&&(r.req=n),r.req.readyState="done",r.req.result=t,delete r.req.error;var i=e.Event("success");e.util.callback("onsuccess",r.req,i),a++,s()}function o(){r.req.readyState="done",r.req.error="DOMError";var t=e.Event("error",arguments);e.util.callback("onerror",r.req,t),a++,s()}function s(){return a>=t.__requests.length?(t.__active=!1,t.__requests=[],void 0):(r=t.__requests[a],r.op(n,r.args,i,o),void 0)}t.__tx=n;var r=null,a=0;try{s()}catch(c){e.DEBUG&&console.log("An exception occured in transaction",arguments),"function"==typeof t.onerror&&t.onerror()}},function(){e.DEBUG&&console.log("An error in transaction",arguments),"function"==typeof t.onerror&&t.onerror()},function(){e.DEBUG&&console.log("Transaction completed",arguments),"function"==typeof t.oncomplete&&t.oncomplete()})},1)},o.prototype.__addToTransactionQueue=function(t,n){this.__active||this.mode===i||e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished.",this.__mode);var o=this.__createRequest();return this.__pushToQueue(o,t,n),o},o.prototype.__createRequest=function(){var t=new e.IDBRequest;return t.source=this.db,t},o.prototype.__pushToQueue=function(e,t,n){this.__requests.push({op:t,args:n,req:e}),this.__executeRequests()},o.prototype.objectStore=function(t){return new e.IDBObjectStore(t,this)},o.prototype.abort=function(){!this.__active&&e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",this.__active)},o.prototype.READ_ONLY=0,o.prototype.READ_WRITE=1,o.prototype.VERSION_CHANGE=2,e.IDBTransaction=o}(idbModules),function(e){var t=function(t,n,i,o){this.__db=t,this.version=i,this.__storeProperties=o,this.objectStoreNames=new e.util.StringList;for(var s=0;s<o.rows.length;s++)this.objectStoreNames.push(o.rows.item(s).name);this.name=n,this.onabort=this.onerror=this.onversionchange=null};t.prototype.createObjectStore=function(t,n){var i=this;n=n||{},n.keyPath=n.keyPath||null;var o=new e.IDBObjectStore(t,i.__versionTransaction,!1),s=i.__versionTransaction;return s.__addToTransactionQueue(function(s,r,a){function c(){e.util.throwDOMException(0,"Could not create new object store",arguments)}i.__versionTransaction||e.util.throwDOMException(0,"Invalid State error",i.transaction);var u=["CREATE TABLE",e.util.quote(t),"(key BLOB",n.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");e.DEBUG&&console.log(u),s.executeSql(u,[],function(e){e.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[t,n.keyPath,n.autoIncrement?!0:!1,"{}"],function(){o.__setReadyState("createObjectStore",!0),a(o)},c)},c)}),i.objectStoreNames.push(t),o},t.prototype.deleteObjectStore=function(t){var n=function(){e.util.throwDOMException(0,"Could not delete ObjectStore",arguments)},i=this;!i.objectStoreNames.contains(t)&&n("Object Store does not exist"),i.objectStoreNames.splice(i.objectStoreNames.indexOf(t),1);var o=i.__versionTransaction;
o.__addToTransactionQueue(function(){i.__versionTransaction||e.util.throwDOMException(0,"Invalid State error",i.transaction),i.__db.transaction(function(i){i.executeSql("SELECT * FROM __sys__ where name = ?",[t],function(i,o){o.rows.length>0&&i.executeSql("DROP TABLE "+e.util.quote(t),[],function(){i.executeSql("DELETE FROM __sys__ WHERE name = ?",[t],function(){},n)},n)})})})},t.prototype.close=function(){},t.prototype.transaction=function(t,n){var i=new e.IDBTransaction(t,n||1,this);return i},e.IDBDatabase=t}(idbModules),function(e){var t=4194304;if(window.openDatabase){var n=window.openDatabase("__sysdb__",1,"System Database",t);n.transaction(function(t){t.executeSql("SELECT * FROM dbVersions",[],function(){},function(){n.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){},function(){e.util.throwDOMException("Could not create table __sysdb__ to save DB versions")})})})},function(){e.DEBUG&&console.log("Error in sysdb transaction - when selecting from dbVersions",arguments)});var i={open:function(i,o){function s(){if(!c){var t=e.Event("error",arguments);a.readyState="done",a.error="DOMError",e.util.callback("onerror",a,t),c=!0}}function r(r){var c=window.openDatabase(i,1,i,t);a.readyState="done","undefined"==typeof o&&(o=r||1),(0>=o||r>o)&&e.util.throwDOMException(0,"An attempt was made to open a database using a lower version than the existing version.",o),c.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){t.executeSql("SELECT * FROM __sys__",[],function(t,u){var l=e.Event("success");a.source=a.result=new e.IDBDatabase(c,i,o,u),o>r?n.transaction(function(t){t.executeSql("UPDATE dbVersions set version = ? where name = ?",[o,i],function(){var t=e.Event("upgradeneeded");t.oldVersion=r,t.newVersion=o,a.transaction=a.result.__versionTransaction=new e.IDBTransaction([],2,a.source),e.util.callback("onupgradeneeded",a,t,function(){var t=e.Event("success");e.util.callback("onsuccess",a,t)})},s)},s):e.util.callback("onsuccess",a,l)},s)},s)},s)}var a=new e.IDBOpenRequest,c=!1;return n.transaction(function(e){e.executeSql("SELECT * FROM dbVersions where name = ?",[i],function(e,t){0===t.rows.length?e.executeSql("INSERT INTO dbVersions VALUES (?,?)",[i,o||1],function(){r(0)},s):r(t.rows.item(0).version)},s)},s),a},deleteDatabase:function(i){function o(t){if(!a){r.readyState="done",r.error="DOMError";var n=e.Event("error");n.message=t,n.debug=arguments,e.util.callback("onerror",r,n),a=!0}}function s(){n.transaction(function(t){t.executeSql("DELETE FROM dbVersions where name = ? ",[i],function(){r.result=void 0;var t=e.Event("success");t.newVersion=null,t.oldVersion=c,e.util.callback("onsuccess",r,t)},o)},o)}var r=new e.IDBOpenRequest,a=!1,c=null;return n.transaction(function(n){n.executeSql("SELECT * FROM dbVersions where name = ?",[i],function(n,a){if(0===a.rows.length){r.result=void 0;var u=e.Event("success");return u.newVersion=null,u.oldVersion=c,e.util.callback("onsuccess",r,u),void 0}c=a.rows.item(0).version;var l=window.openDatabase(i,1,i,t);l.transaction(function(t){t.executeSql("SELECT * FROM __sys__",[],function(t,n){var i=n.rows;!function r(n){n>=i.length?t.executeSql("DROP TABLE __sys__",[],function(){s()},o):t.executeSql("DROP TABLE "+e.util.quote(i.item(n).name),[],function(){r(n+1)},function(){r(n+1)})}(0)},function(){s()})},o)})},o),r},cmp:function(t,n){return e.Key.encode(t)>e.Key.encode(n)?1:t===n?0:-1}};e.shimIndexedDB=i}}(idbModules),function(e,t){"undefined"!=typeof e.openDatabase&&(e.shimIndexedDB=t.shimIndexedDB,e.shimIndexedDB&&(e.shimIndexedDB.__useShim=function(){e.indexedDB=t.shimIndexedDB,e.IDBDatabase=t.IDBDatabase,e.IDBTransaction=t.IDBTransaction,e.IDBCursor=t.IDBCursor,e.IDBKeyRange=t.IDBKeyRange},e.shimIndexedDB.__debug=function(e){t.DEBUG=e})),e.indexedDB=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,"undefined"==typeof e.indexedDB&&"undefined"!=typeof e.openDatabase?e.shimIndexedDB.__useShim():(e.IDBDatabase=e.IDBDatabase||e.webkitIDBDatabase,e.IDBTransaction=e.IDBTransaction||e.webkitIDBTransaction,e.IDBCursor=e.IDBCursor||e.webkitIDBCursor,e.IDBKeyRange=e.IDBKeyRange||e.webkitIDBKeyRange,e.IDBTransaction||(e.IDBTransaction={}),e.IDBTransaction.READ_ONLY=e.IDBTransaction.READ_ONLY||"readonly",e.IDBTransaction.READ_WRITE=e.IDBTransaction.READ_WRITE||"readwrite")}(window,idbModules),define("indexedDBShim",function(){}),define("db",["indexedDBShim"],function(){var e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB,t=window.IDBKeyRange||window.webkitIDBKeyRange,n={readonly:"readonly",readwrite:"readwrite"},i=Object.prototype.hasOwnProperty;if(!e)throw"IndexedDB required";var o=function(e){return e},s=function(){var e,t=[],n=function(n,i){if(t){i=i||[],e=e||[n,i];for(var o=0,s=t.length;s>o;o++)t[o].apply(e[0],e[1]);t=[]}};this.add=function(){for(var i=0,o=arguments.length;o>i;i++)t.push(arguments[i]);return e&&n(),this},this.execute=function(){return n(this,arguments),this}},r=function(e){var t="progress",n=[["resolve","done",new s,"resolved"],["reject","fail",new s,"rejected"],["notify","progress",new s]],i={},o={state:function(){return t},then:function(){var e=arguments;return r(function(t){n.forEach(function(n,o){var s=e[o];i[n[1]]("function"==typeof s?function(){var e=s.apply(this,arguments);e&&"function"==typeof e.promise&&e.promise().done(t.resolve).fail(t.reject).progress(t.notify)}:t[n[0]])})}).promise()},promise:function(e){return e?(Object.keys(o).forEach(function(t){e[t]=o[t]}),e):o}};return n.forEach(function(e){var n=e[2],s=e[3];o[e[1]]=n.add,s&&n.add(function(){t=s}),i[e[0]]=n.execute}),o.promise(i),e&&e.call(i,i),i},a=function(e,t){var o=this,s=!1;this.add=function(t){if(s)throw"Database has been closed";for(var i=[],a=0;a<arguments.length-1;a++)i[a]=arguments[a+1];var c=e.transaction(t,n.readwrite),u=c.objectStore(t),l=r();return i.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item,t=u.add(e,n)}else t=u.add(e);t.onsuccess=function(t){var n=t.target,i=n.source.keyPath;null===i&&(i="__id__"),Object.defineProperty(e,i,{value:n.result,enumerable:!0}),l.notify()}}),c.oncomplete=function(){l.resolve(i,o)},c.onerror=function(e){l.reject(i,e)},c.onabort=function(e){l.reject(i,e)},l.promise()},this.update=function(t){if(s)throw"Database has been closed";for(var i=[],a=0;a<arguments.length-1;a++)i[a]=arguments[a+1];var c=e.transaction(t,n.readwrite),u=c.objectStore(t),l=(u.keyPath,r());return i.forEach(function(e){var t;if(e.item&&e.key){var n=e.key;e=e.item,t=u.put(e,n)}else t=u.put(e);t.onsuccess=function(){l.notify()}}),c.oncomplete=function(){l.resolve(i,o)},c.onerror=function(e){l.reject(i,e)},c.onabort=function(e){l.reject(i,e)},l.promise()},this.remove=function(t,i){if(s)throw"Database has been closed";var o=e.transaction(t,n.readwrite),a=o.objectStore(t),c=r();return a.delete(i),o.oncomplete=function(){c.resolve(i)},o.onerror=function(e){c.reject(e)},c.promise()},this.clear=function(t){if(s)throw"Database has been closed";var i=e.transaction(t,n.readwrite),o=i.objectStore(t),a=r();return o.clear(),i.oncomplete=function(){a.resolve()},i.onerror=function(e){a.reject(e)},a.promise()},this.close=function(){if(s)throw"Database has been closed";e.close(),s=!0,delete d[t]},this.get=function(t,n){if(s)throw"Database has been closed";var i=e.transaction(t),o=i.objectStore(t),a=r(),c=o.get(n);return c.onsuccess=function(e){a.resolve(e.target.result)},i.onerror=function(e){a.reject(e)},a.promise()},this.query=function(t,n){if(s)throw"Database has been closed";return new c(t,e,n)};for(var a=0,u=e.objectStoreNames.length;u>a;a++)!function(e){o[e]={};for(var t in o)i.call(o,t)&&"close"!==t&&(o[e][t]=function(t){return function(){var n=[e].concat([].slice.call(arguments,0));return o[t].apply(o,n)}}(t))}(e.objectStoreNames[a])},c=function(e,i,s){var a=this,c=!1,u=function(o,a,u,l,d,f,h){var _=i.transaction(e,c?n.readwrite:n.readonly),p=_.objectStore(e),m=s?p.index(s):p,v=o?t[o].apply(null,a):null,y=[],b=r(),g=[v],d=d?d:null,f=f?f:[],w=0;"count"!==u&&g.push(l||"next");var x=c?Object.keys(c):!1,S=function(e){for(var t=0;t<x.length;t++){var n=x[t],i=c[n];i instanceof Function&&(i=i(e)),e[n]=i}return e};return m[u].apply(m,g).onsuccess=function(e){var t=e.target.result;if("number"==typeof t)y=t;else if(t)if(null!==d&&d[0]>w)w=d[0],t.advance(d[0]);else if(null!==d&&w>=d[0]+d[1]);else{var n=!0,i="value"in t?t.value:t.key;f.forEach(function(e){e&&e.length&&(n=2===e.length?i[e[0]]===e[1]:e[0].apply(void 0,[i]))}),n&&(w++,y.push(h(i)),c&&(i=S(i),t.update(i))),t.continue()}},_.oncomplete=function(){b.resolve(y)},_.onerror=function(e){b.reject(e)},_.onabort=function(e){b.reject(e)},b.promise()},l=function(e,t){var n="next",i="openCursor",s=[],r=null,a=o,l=!1,d=function(){return u(e,t,i,l?n+"unique":n,r,s,a)},f=function(){return r=Array.prototype.slice.call(arguments,0,2),1==r.length&&r.unshift(0),{execute:d}},h=function(){return n=null,i="count",{execute:d}},_=function(){return i="openKeyCursor",{desc:m,execute:d,filter:p,distinct:v,map:b}},p=function(){return s.push(Array.prototype.slice.call(arguments,0,2)),{keys:_,execute:d,filter:p,desc:m,distinct:v,modify:y,limit:f,map:b}},m=function(){return n="prev",{keys:_,execute:d,filter:p,distinct:v,modify:y,map:b}},v=function(){return l=!0,{keys:_,count:h,execute:d,filter:p,desc:m,modify:y,map:b}},y=function(e){return c=e,{execute:d}},b=function(e){return a=e,{execute:d,count:h,keys:_,filter:p,desc:m,distinct:v,modify:y,limit:f,map:b}};return{execute:d,count:h,keys:_,filter:p,desc:m,distinct:v,modify:y,limit:f,map:b}};"only bound upperBound lowerBound".split(" ").forEach(function(e){a[e]=function(){return new l(e,arguments)}}),this.filter=function(){var e=new l(null,null);return e.filter.apply(e,arguments)},this.all=function(){return this.filter()}},u=function(e,t,n){"function"==typeof t&&(t=t());for(var o in t){var s,r=t[o];s=!i.call(t,o)||n.objectStoreNames.contains(o)?e.currentTarget.transaction.objectStore(o):n.createObjectStore(o,r.key);for(var a in r.indexes){var c=r.indexes[a];s.createIndex(a,c.key||a,Object.keys(c).length?c:{unique:!1})}}},l=function(e,t){var n=e.target.result,i=new a(n,t),o=r();return o.resolve(i),d[t]=n,o.promise()},d={},f={version:"0.9.0",open:function(t){var n,i=r(),o=d[t.server];if(o)for(var s in t.schema)o.objectStoreNames.contains(s)||(o.close(),delete d[t.server]);return d[t.server]?l({target:{result:d[t.server]}},t.server,t.version,t.schema).done(i.resolve).fail(i.reject).progress(i.notify):(n=e.open(t.server,t.version),n.onsuccess=function(e){l(e,t.server,t.version,t.schema).done(i.resolve).fail(i.reject).progress(i.notify)},n.onupgradeneeded=function(e){u(e,t.schema,e.target.result)},n.onerror=function(e){i.reject(e)}),i.promise()}};return f}),define("data",["class","db"],function(e,t){var n=e.extend({_server:null,_files:null,_initCallbacks:null,init:function(){this._files=[],this._initCallbacks=[],t.open({server:"draw",version:1,schema:{files:{key:{keyPath:"id"},indexes:{id:{unique:!0}}}}}).done(function(e){console.log("Set up files server"),this._server=e;for(var t=0;t<this._initCallbacks.length;t++){var n=this._initCallbacks[t];n.func.apply(this,n.args)}}.bind(this)).fail(function(e){console.error("Failed setting up database",e)})},_doLater:function(e,t){this._initCallbacks.push({func:e,args:t})},getFiles:function(e){if(!this._server)return this._doLater(this.getFiles,[e]),void 0;if(!e)throw"You must specify a callback";this._server.files.query().all().execute().done(function(t){e(t)}.bind(this))},createFile:function(e){if(!this._server)return this._doLater(this.createFile,[e]),void 0;if(!e)throw"You must specify a callback";var t=this._getGuid(),n={id:t,name:"Untitled File"};this._server.files.add(n).done(function(t){var n=t[0];this.getFile(n.id,function(){e(n)}.bind(this))}.bind(this)).fail(function(e){console.error("fail to add file to file list",e)})},getFile:function(e,n){return this._server?(t.open({server:e,version:1,schema:{actions:{key:{keyPath:"id",autoIncrement:!0},indexes:{type:{},id:{unique:!0}}}}}).done(function(t){this._files[e]=t,n(t)}.bind(this)).fail(function(e){console.error("Failed to create file database",e)}),void 0):(this._doLater(this.getFile,[e,n]),void 0)},renameFile:function(e,t){return this._server?(this._server.files.query("id").only(e).modify({name:t}).execute().done(function(e){console.log("Want to rename file",e)}).fail(function(e){console.error("Couldn't find file",e)}),void 0):(this._doLater(this.renameFile,[e]),void 0)},deleteFile:function(e){return this._server?(this._server.files.remove(e).done(function(t){console.log("Deleted file from file table",e);var n=indexedDB.deleteDatabase(e);n.onsuccess=function(){console.log("Deleted Database for file",t)},n.onerror=function(e){console.log("Error deleting database",e)},delete localStorage[e]}).fail(function(){console.error("Failed to delete file from file table",e)}),void 0):(this._doLater(this.deleteFile,[e]),void 0)},localFileSettings:function(e,t){return t&&(localStorage[e]=JSON.stringify(t)),localStorage[e]||(localStorage[e]=JSON.stringify({offsetX:0,offsetY:0,scale:1})),JSON.parse(localStorage[e])},deleteAllDatabases:function(){var e=indexedDB.webkitGetDatabaseNames();e.onsuccess=function(e){for(var t=e.target.result,n=0;n<t.length;n++){console.log("Deleting",t[n]);var i=indexedDB.deleteDatabase(t[n]);window.d=i,i.onerror=function(e){console.error("Error deleting database",e)}}console.log(e)}},_getGuid:function(){return"T^"+Date.now()+"-"+Math.round(1e6*Math.random())}}),i=new n;return window.data=i,i}),define("templates/fileList",[],function(){function e(){var e='<li class="file-info"><div class="thumbnail-wrapper"><canvas class="thumbnail"></canvas></div><div class="file-details"><span class="file-name"></span><span data-action="delete">Delete</span></div></li',t=document.createElement("div");return t.innerHTML=e,t.firstChild}return e}),define("components/drawCanvas",["class","helpers"],function(e,t){var n=e.extend({_canvas:null,_ctx:null,_settings:null,init:function(e,t){this._canvas=e,this._ctx=e.getContext("2d"),this._settings=t},drawAll:function(e){this._ctx.setTransform(this._settings.scale,0,0,this._settings.scale,this._settings.offsetX,this._settings.offsetY);var n=t.screenToWorld(this._settings,0,0),i=t.screenToWorld(this._settings,this._canvas.width,this._canvas.height);this._ctx.clearRect(n.x,n.y,i.x-n.x,i.y-n.y);var o=1;this._ctx.lineWidth=o/this._settings.scale;for(var s=0;s<e.length;s++){var r=e[s];this.doAction(r)}},doAction:function(e){"stroke"==e.type&&this._drawStroke(e.stroke)},updateSettings:function(e){this._settings=e},_drawStroke:function(e){if(!(e.points.length<2)){var n=[],i=e.points;n=e.controlPoints?e.controlPoints:t.getCurveControlPoints(i);var o=i[0];this._ctx.beginPath(),this._ctx.moveTo(o.x,o.y);for(var s=1;s<i.length;s++){o=i[s];var r=n[s-1].first,a=n[s-1].second;this._ctx.bezierCurveTo(r.x,r.y,a.x,a.y,o.x,o.y)}this._ctx.stroke()}}});return n}),define("components/manipulateCanvas",["components/drawCanvas","helpers"],function(e,t){var n=e.extend({zoom:function(e,n,i){if(this._settings.scale+i<.001||this._settings.scale+i>2e4)return!1;var o=t.screenToWorld(this._settings,e,n);this._settings.scale+=i;var s=t.worldToScreen(this._settings,o.x,o.y),r={x:e-s.x,y:n-s.y};return this._settings.offsetX+=r.x,this._settings.offsetY+=r.y,!0},pan:function(e,t){return this._settings.offsetX+=e,this._settings.offsetY+=t,!0},panTo:function(e,t){this._settings.offsetX=e,this._settings.offsetY=t}});return n}),define("components/thumbnail",["class","helpers","data","components/manipulateCanvas"],function(e,t,n,i){var o=e.extend({_canvas:null,init:function(e){this._canvas=e},render:function(e){data.getFile(e.id,function(n){n.actions.query().all().execute().done(function(n){var o=data.localFileSettings(e.id),s=new i(this._canvas,o),r={x:window.innerWidth/2,y:window.innerHeight/2},a=t.screenToWorld(o,r.x,r.y),c=Math.min(this._canvas.width/window.innerWidth,this._canvas.height/window.innerHeight),u=o.scale*c-o.scale;s.zoom(0,0,u);var l={x:this._canvas.width/2,y:this._canvas.height/2},d=t.worldToScreen(o,a.x,a.y),f={x:l.x-d.x,y:l.y-d.y};s.pan(f.x,f.y),s.drawAll(n),window.a=n,window.c=s}.bind(this))}.bind(this))}});return o}),define("sections/fileList",["section","tapHandler","helpers","data","templates/fileList","components/thumbnail"],function(e,t,n,i,o,s){var r=e.extend({id:"files-list-container",_filesPane:null,_fileListElement:null,_files:null,_resizeTimeout:null,init:function(e){this._super(),this._filesPane=e,this._fileListElement=document.getElementById("files-list"),this._files={},this._resizeAndRender=this._resizeAndRender.bind(this),this._actuallyResizeAndRender=this._actuallyResizeAndRender.bind(this),i.getFiles(function(e){console.log("got files",e);for(var t=0;t<e.length;t++){var n=e[t];this._files[n.id]=n;var i=this._newFileWrapper(n);this._fileListElement.appendChild(i)}this._actuallyResizeAndRender()}.bind(this)),new t(document.getElementById("file-create"),{tap:this._newDoc.bind(this)}),new t(this._fileListElement,{tap:this._docSelected.bind(this)})},show:function(e){if(e){var t=this._files[e.id];t||console.error("We somehow came from a file that doesn't exist"),t.thumbnail.render(t.file)}window.addEventListener("resize",this._resizeAndRender)},hide:function(){window.removeEventListener("resize",this._resizeAndRender)},_newFileWrapper:function(e){var t=new o,n=t.getElementsByClassName("thumbnail")[0],i=t.getElementsByClassName("file-name")[0],r=new s(n);return i.innerText=e.name,t.fileId=e.id,this._files[e.id]={element:t,file:e,canvas:n,thumbnail:r},t},_resizeAndRender:function(){this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(this._actuallyResizeAndRender.bind(this),500)},_actuallyResizeAndRender:function(){for(var e in this._files){var t=this._files[e],n=t.canvas.parentElement;t.canvas.width=n.offsetWidth,t.canvas.height=n.offsetHeight,t.thumbnail.render(t.file)}},_newDoc:function(){console.log("new doc"),data.createFile(function(e){var t=this._newFileWrapper(e);this._fileListElement.appendChild(t)}.bind(this))},_docSelected:function(e){var t=e.srcElement,i=n.parentEleWithClassname(e.srcElement,"file-info");if(i){if(t.dataset.action&&"delete"==t.dataset.action){var o=this._files[i.fileId];return this._fileListElement.removeChild(o.element),delete this._files[i.fileId],data.deleteFile(i.fileId),void 0}this._filesPane.setPane("draw",this._files[i.fileId].file)}}});return r}),define("sections/draw",["section","globals","helpers","tapHandler","db","data","components/manipulateCanvas"],function(e,t,n,i,o,s,r){var a=e.extend({id:"draw",_filesPane:null,_manipulateCanvas:null,_canvas:null,_fileInfo:null,_fileServer:null,_settings:null,_actions:null,_currentAction:null,_needsUpdate:!0,_shouldRender:!1,_currentTool:"pan",_currentPointTool:"pencil",_saveTransformTimeout:null,_redoStack:null,init:function(e){this._super(),this._filesPane=e,this._canvas=document.getElementById("canvas"),this._resize=this._resize.bind(this),new i(canvas,{start:this._start.bind(this),move:this._move.bind(this),end:this._end.bind(this),gesture:this._gesture.bind(this)}),new i(document.getElementById("tools"),{tap:this._toolChanged.bind(this),start:this._toolStart.bind(this),end:this._toolEnd.bind(this)}),new i(document.getElementById("menu"),{tap:this._menuTapped.bind(this)}),this.element.addEventListener("mousewheel",this._mouseWheel.bind(this)),this.element.addEventListener("keydown",this._keyDown.bind(this))},show:function(e){this._fileInfo=e,this._actions=[],this._redoStack=[],console.log("draw shown for file",e),data.getFile(e.id,function(t){this._fileServer=t,this._fileServer.actions.query().all().execute().done(function(t){this._actions=t,this._needsUpdate=!0,this._settings=data.localFileSettings(e.id),this._manipulateCanvas=new r(this._canvas,this._settings),this._shouldRender=!0,this._redraw()}.bind(this))}.bind(this)),this._resize(),setTimeout(function(){canvas.focus()}.bind(this),400),window.addEventListener("resize",this._resize)},hide:function(){this._shouldRender=!1,window.removeEventListener("resize",this._resize)},_resize:function(){this._canvas.width=window.innerWidth,this._canvas.height=window.innerHeight,this._needsUpdate=!0},_zoom:function(e,t,n){this._manipulateCanvas.zoom(e,t,n)&&(this._saveTransform(),this._needsUpdate=!0)},_pan:function(e,t){this._manipulateCanvas.pan(e,t)&&(this._saveTransform(),this._needsUpdate=!0)},_mouseWheel:function(e){"pan"==this._currentTool?this._pan(-e.deltaX,-e.deltaY):"zoom"==this._currentTool&&0!=e.deltaY&&this._zoom(e.offsetX,e.offsetY,e.deltaY/100*this._settings.scale)},_start:function(e){var t=n.screenToWorld(this._settings,e.distFromLeft,e.distFromTop);console.log("started at",t),this._currentAction&&console.error("Current action isn't null!"),this._currentAction={type:"stroke",stroke:{points:[t]}},this._redoStack=[]},_move:function(e){var t=n.screenToWorld(this._settings,e.distFromLeft,e.distFromTop),i=this._currentAction.stroke,o=i.points,s=o[o.length-1],r=Math.sqrt((s.x-t.x)*(s.x-t.x)+(s.y-t.y)*(s.y-t.y));.001>r||(i.points.push(t),this._needsUpdate=!0)},_end:function(){var e=this._currentAction;this._currentAction=null;var t=e.stroke;if(!(t.points.length<2)){var i=n.getCurveControlPoints(t.points);t.controlPoints=i,this._saveAction(e)}},_saveAction:function(e){this._actions.push(e),this._fileServer.actions.add(e).done(function(){}).fail(function(e){console.error("fail to write",e)}),this._needsUpdate=!0},_gesture:function(e){this._pan(e.xFromLast,e.yFromLast),this._zoom(e.x,e.y,e.scaleFromLast*this._settings.scale)},_redraw:function(){this._shouldRender&&(this._needsUpdate&&(this._manipulateCanvas.drawAll(this._actions),this._currentAction&&this._manipulateCanvas.doAction(this._currentAction),this._needsUpdate=!1),requestAnimationFrame(this._redraw.bind(this)))},_menuTapped:function(e){if("LI"==e.srcElement.tagName){var t=e.srcElement.dataset.action;"back"==t&&this._filesPane.setPane("list",this._fileInfo)}},_toolChanged:function(e){"LI"==e.srcElement.tagName&&(this._currentTool=e.srcElement.dataset.tool)},_toolStart:function(e){"LI"==e.srcElement.tagName},_toolEnd:function(){},_keyDown:function(e){var n=String.fromCharCode(e.keyCode);if(t.isMac()&&e.metaKey&&e.shiftKey&&"Z"==n||t.isPC()&&e.ctrlKey&&"Y"==n){if(this._redoStack.length>0){var i=this._redoStack.pop();this._saveAction(i)}}else if((t.isMac()&&e.metaKey||t.isPC()&&e.ctrlKey)&&"Z"==n){if(e.preventDefault(),this._actions.length>0){var o=this._actions.pop(),s={};for(var r in o)"id"!=r&&(s[r]=o[r]);this._redoStack.push(s),this._fileServer.actions.remove(o.id).done(function(e){console.log("remove",e,o)})}this._needsUpdate=!0}else"Z"==n?this._currentTool="zoom":"P"==n&&(this._currentTool="pan")},_saveTransform:function(){this._saveTransformTimeout&&clearTimeout(this._saveTransformTimeout),this._saveTransformTimeout=setTimeout(function(){data.localFileSettings(this._fileInfo.id,this._settings),this._saveTransformTimeout=null}.bind(this),100)}});return a}),define("managers/files",["section","event","sections/fileList","sections/draw"],function(e,t,n,i){var o=e.extend({id:"files",_paneWrapper:null,_screenWidth:0,_defaultSettings:{},panes:null,currentPaneName:null,init:function(){this._super(),this._defaultSettings={title:{text:"Photos"}},this._screenWidth=window.innerWidth,this._paneWrapper=document.getElementById("files-pane-wrapper"),this._windowResized=this._windowResized.bind(this),this._finishedSliding=this._finishedSliding.bind(this),this._paneWrapper.addEventListener("webkitTransitionEnd",this._finishedSliding),this.panes={},this.panes.list={offsetX:0,pane:new n(this)},this.panes.draw={offsetX:this._screenWidth,pane:new i(this)},this.panes.draw.pane.element.style.webkitTransform="translate("+this._screenWidth+"px, 0)";var e={pane:"list",details:null};localStorage.filesPane&&(e=JSON.parse(localStorage.filesPane)),this.setPane(e.pane,e.details),window.files=this},show:function(){window.addEventListener("resize",this._windowResized)},hide:function(){window.removeEventListener("resize",this._windowResized)},setPane:function(e,t){if(this.currentPaneName!=e){var n=null;if(this.currentPaneName){var n=this.panes[this.currentPaneName].pane;n.hide&&n.hide(),n.afterHide()}n=this.panes[e].pane,n.show&&n.show(t),n.afterShow(),this.currentPaneName=e;var i=this.panes[e],o="translate3d("+-1*i.offsetX+"px, 0px, 0px)";this._paneWrapper.style.webkitTransform!=o&&(this._paneWrapper.classList.add("ani4"),this._paneWrapper.style.webkitTransform=o),"list"==e?delete localStorage.filesPane:localStorage.filesPane=JSON.stringify({pane:e,details:t})}},_finishedSliding:function(){this._paneWrapper.classList.remove("ani4"),this._redoOffsets(),this._paneWrapper.style.webkitTransform="translate3d(0px, 0px, 0px)"},_windowResized:function(){this._redoOffsets()},_redoOffsets:function(){this._screenWidth=window.innerWidth;var e=0;for(var t in this.panes){if(this.currentPaneName==t)break;e++}var n=-1*e*this._screenWidth;for(var t in this.panes)this.panes[t].offsetX=n,this.panes[t].pane.element.style.webkitTransform="translate("+n+"px, 0)",n+=this._screenWidth}});return o}),define("sections/main",["section","event","managers/files"],function(e,t,n){var i=e.extend({id:"main-container",mainContent:null,panes:null,currentPane:"",init:function(){this._super(),this.mainContent=document.getElementById("main-content"),this.panes={},this.panes.files=new n,t.addListener("logout",this._logout.bind(this))},show:function(){console.log("screens shown"),localStorage.currentPane?this.setPane(localStorage.currentPane):this.setPane("files")},setPane:function(e){if(this.currentPane!=e){var n=null;if(this.currentPane){var n=this.panes[this.currentPane];n.hide&&n.hide(),n.afterHide()}n=this.panes[e],n.show&&n.show(),n.afterShow(),this.currentPane=e,localStorage.currentPane=e,t.trigger("paneChanged",{pane:n})}},_logout:function(){delete localStorage.currentPane}});return i}),define("managers/login",["event","sections/login","sections/main"],function(e,t,n){function i(){this.init()}return i.prototype={pages:null,currentPage:"",init:function(){this.pages={},e.addListener("login",this._login.bind(this)),e.addListener("logout",this._logout.bind(this)),this.pages.login=new t,this.pages.main=new n,"true"==localStorage.loggedIn?this.setPage("main"):this.setPage("login")},setPage:function(e){var t=null;if(this.currentPage){var t=this.pages[this.currentPage];t.hide&&t.hide(),t.afterHide()}t=this.pages[e],t.show&&t.show(),t.afterShow(),this.currentPage=e},_login:function(){localStorage.loggedIn=!0,this.setPage("main")},_logout:function(){localStorage.loggedIn=!1,this.setPage("login")}},i}),require(["event","globals","managers/login"],function(e,t,n){function i(){window.log=console.log.bind(console),document.addEventListener("touchmove",function(e){e.preventDefault()}),document.addEventListener("mousewheel",function(e){e.preventDefault()}),t.setHTMLDevices();var e=new n;window.login=e}"interactive"===document.readyState||"complete"===document.readyState?i():document.addEventListener("DOMContentLoaded",i,!1)}),define("main",function(){})}();
//# sourceMappingURL=main.min.js.map