!function(){function e(){window.log=console.log.bind(console),window.addEventListener("wheel",function(e){e.preventDefault()}),i(["promise","event","globals","helpers","migrate","managers/login","gauth"],function(e,t,i,n,s,o){function r(){document.body.style.height=window.innerHeight+"px"}s.run().then(function(){i.setHTMLDevices(),new o}.bind(this)),window.addEventListener("resize",function(){window.scroll(0,0),r()}),r()})}var t,i,n;!function(e){function s(e,t){return w.call(e,t)}function o(e,t){var i,n,s,o,r,a,c,l,u,h,d=t&&t.split("/"),f=g.map,m=f&&f["*"]||{};if(e&&"."===e.charAt(0))if(t){for(d=d.slice(0,d.length-1),e=d.concat(e.split("/")),l=0;l<e.length;l+=1)if(h=e[l],"."===h)e.splice(l,1),l-=1;else if(".."===h){if(1===l&&(".."===e[2]||".."===e[0]))break;l>0&&(e.splice(l-1,2),l-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((d||m)&&f){for(i=e.split("/"),l=i.length;l>0;l-=1){if(n=i.slice(0,l).join("/"),d)for(u=d.length;u>0;u-=1)if(s=f[d.slice(0,u).join("/")],s&&(s=s[n])){o=s,r=l;break}if(o)break;!a&&m&&m[n]&&(a=m[n],c=l)}!o&&a&&(o=a,r=c),o&&(i.splice(0,r,o),e=i.join("/"))}return e}function r(t,i){return function(){return f.apply(e,y.call(arguments,0).concat([t,i]))}}function a(e){return function(t){return o(t,e)}}function c(e){return function(t){v[e]=t}}function l(t){if(s(p,t)){var i=p[t];delete p[t],b[t]=!0,d.apply(e,i)}if(!s(v,t)&&!s(b,t))throw new Error("No "+t);return v[t]}function u(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function h(e){return function(){return g&&g.config&&g.config[e]||{}}}var d,f,m,_,v={},p={},g={},b={},w=Object.prototype.hasOwnProperty,y=[].slice;m=function(e,t){var i,n=u(e),s=n[0];return e=n[1],s&&(s=o(s,t),i=l(s)),s?e=i&&i.normalize?i.normalize(e,a(t)):o(e,t):(e=o(e,t),n=u(e),s=n[0],e=n[1],s&&(i=l(s))),{f:s?s+"!"+e:e,n:e,pr:s,p:i}},_={require:function(e){return r(e)},exports:function(e){var t=v[e];return"undefined"!=typeof t?t:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:h(e)}}},d=function(t,i,n,o){var a,u,h,d,f,g,w=[];if(o=o||t,"function"==typeof n){for(i=!i.length&&n.length?["require","exports","module"]:i,f=0;f<i.length;f+=1)if(d=m(i[f],o),u=d.f,"require"===u)w[f]=_.require(t);else if("exports"===u)w[f]=_.exports(t),g=!0;else if("module"===u)a=w[f]=_.module(t);else if(s(v,u)||s(p,u)||s(b,u))w[f]=l(u);else{if(!d.p)throw new Error(t+" missing "+u);d.p.load(d.n,r(o,!0),c(u),{}),w[f]=v[u]}h=n.apply(v[t],w),t&&(a&&a.exports!==e&&a.exports!==v[t]?v[t]=a.exports:h===e&&g||(v[t]=h))}else t&&(v[t]=n)},t=i=f=function(t,i,n,s,o){return"string"==typeof t?_[t]?_[t](i):l(m(t,i).f):(t.splice||(g=t,i.splice?(t=i,i=n,n=null):t=e),i=i||function(){},"function"==typeof n&&(n=s,s=o),s?d(e,t,i,n):setTimeout(function(){d(e,t,i,n)},4),f)},f.config=function(e){return g=e,g.deps&&f(g.deps,g.callback),f},t._defined=v,n=function(e,t,i){t.splice||(i=t,t=[]),s(v,e)||s(p,e)||(p[e]=[e,t,i])},n.amd={jQuery:!0}}(),n("almond",function(){}),function(){var e,t,i,n;!function(){var s={},o={};e=function(e,t,i){s[e]={deps:t,callback:i}},n=i=t=function(e){function i(t){if("."!==t.charAt(0))return t;for(var i=t.split("/"),n=e.split("/").slice(0,-1),s=0,o=i.length;o>s;s++){var r=i[s];if(".."===r)n.pop();else{if("."===r)continue;n.push(r)}}return n.join("/")}if(n._eak_seen=s,o[e])return o[e];if(o[e]={},!s[e])throw new Error("Could not find module "+e);for(var r,a=s[e],c=a.deps,l=a.callback,u=[],h=0,d=c.length;d>h;h++)"exports"===c[h]?u.push(r={}):u.push(t(i(c[h])));var f=l.apply(this,u);return o[e]=r||f}}(),e("promise/all",["./utils","exports"],function(e,t){function i(e){var t=this;if(!n(e))throw new TypeError("You must pass an array to all.");return new t(function(t,i){function n(e){return function(t){o(e,t)}}function o(e,i){a[e]=i,0===--c&&t(a)}var r,a=[],c=e.length;0===c&&t([]);for(var l=0;l<e.length;l++)r=e[l],r&&s(r.then)?r.then(n(l),i):o(l,r)})}var n=e.isArray,s=e.isFunction;t.all=i}),e("promise/asap",["exports"],function(e){function t(){return function(){process.nextTick(s)}}function i(){var e=0,t=new c(s),i=document.createTextNode("");return t.observe(i,{characterData:!0}),function(){i.data=e=++e%2}}function n(){return function(){l.setTimeout(s,1)}}function s(){for(var e=0;e<u.length;e++){var t=u[e],i=t[0],n=t[1];i(n)}u=[]}function o(e,t){var i=u.push([e,t]);1===i&&r()}var r,a="undefined"!=typeof window?window:{},c=a.MutationObserver||a.WebKitMutationObserver,l="undefined"!=typeof global?global:this,u=[];r="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?t():c?i():n(),e.asap=o}),e("promise/cast",["exports"],function(e){function t(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=this;return new t(function(t){t(e)})}e.cast=t}),e("promise/config",["exports"],function(e){function t(e,t){return 2!==arguments.length?i[e]:(i[e]=t,void 0)}var i={instrument:!1};e.config=i,e.configure=t}),e("promise/polyfill",["./promise","./utils","exports"],function(e,t,i){function n(){var e="Promise"in window&&"cast"in window.Promise&&"resolve"in window.Promise&&"reject"in window.Promise&&"all"in window.Promise&&"race"in window.Promise&&function(){var e;return new window.Promise(function(t){e=t}),o(e)}();e||(window.Promise=s)}var s=e.Promise,o=t.isFunction;i.polyfill=n}),e("promise/promise",["./config","./utils","./cast","./all","./race","./resolve","./reject","./asap","exports"],function(e,t,i,n,s,o,r,a,c){function l(e){if(!E(e))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof l))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],u(e,this)}function u(e,t){function i(e){_(t,e)}function n(e){p(t,e)}try{e(i,n)}catch(s){n(s)}}function h(e,t,i,n){var s,o,r,a,c=E(i);if(c)try{s=i(n),r=!0}catch(l){a=!0,o=l}else s=n,r=!0;m(t,s)||(c&&r?_(t,s):a?p(t,o):e===F?_(t,s):e===L&&p(t,s))}function d(e,t,i,n){var s=e._subscribers,o=s.length;s[o]=t,s[o+F]=i,s[o+L]=n}function f(e,t){for(var i,n,s=e._subscribers,o=e._detail,r=0;r<s.length;r+=3)i=s[r],n=s[r+t],h(t,i,n,o);e._subscribers=null}function m(e,t){var i,n=null;try{if(e===t)throw new TypeError("A promises callback cannot return that same promise.");if(y(t)&&(n=t.then,E(n)))return n.call(t,function(n){return i?!0:(i=!0,t!==n?_(e,n):v(e,n),void 0)},function(t){return i?!0:(i=!0,p(e,t),void 0)}),!0}catch(s){return i?!0:(p(e,s),!0)}return!1}function _(e,t){e===t?v(e,t):m(e,t)||v(e,t)}function v(e,t){e._state===I&&(e._state=k,e._detail=t,w.async(g,e))}function p(e,t){e._state===I&&(e._state=k,e._detail=t,w.async(b,e))}function g(e){f(e,e._state=F)}function b(e){f(e,e._state=L)}var w=e.config;e.configure;var y=t.objectOrFunction,E=t.isFunction;t.now;var P=i.cast,A=n.all,T=s.race,S=o.resolve,x=r.reject,C=a.asap;w.async=C;var I=void 0,k=0,F=1,L=2;l.prototype={constructor:l,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(e,t){var i=this,n=new this.constructor(function(){});if(this._state){var s=arguments;w.async(function(){h(i._state,n,s[i._state-1],i._detail)})}else d(this,n,e,t);return n},"catch":function(e){return this.then(null,e)}},l.all=A,l.cast=P,l.race=T,l.resolve=S,l.reject=x,c.Promise=l}),e("promise/race",["./utils","exports"],function(e,t){function i(e){var t=this;if(!n(e))throw new TypeError("You must pass an array to race.");return new t(function(t,i){for(var n,s=0;s<e.length;s++)n=e[s],n&&"function"==typeof n.then?n.then(t,i):t(n)})}var n=e.isArray;t.race=i}),e("promise/reject",["exports"],function(e){function t(e){var t=this;return new t(function(t,i){i(e)})}e.reject=t}),e("promise/resolve",["exports"],function(e){function t(e){var t=this;return new t(function(t){t(e)})}e.resolve=t}),e("promise/utils",["exports"],function(e){function t(e){return i(e)||"object"==typeof e&&null!==e}function i(e){return"function"==typeof e}function n(e){return"[object Array]"===Object.prototype.toString.call(e)}var s=Date.now||function(){return(new Date).getTime()};e.objectOrFunction=t,e.isFunction=i,e.isArray=n,e.now=s}),t("promise/polyfill").polyfill()}(),n("promise",function(){}),n("event",[],function(){function e(){this.init()}return e.prototype={listeners:null,init:function(){this.listeners=[]},addListener:function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)},removeListener:function(e,t){if(!this.listeners[e])return!1;var i=this.listeners[e].indexOf(t);return-1!==i?(delete this.listeners[e][i],!0):!1},trigger:function(e,t){return this.listeners[e]?(this.listeners[e].forEach(function(e){e(t)}),!0):!1}},new e}),n("globals",["event"],function(){var e=function(){this.init(),window.g=this};return e.prototype={init:function(){},isiOS:function(){return this.hasDeviceType("iOS")},isPC:function(){return this.hasDeviceType("PC")},isMac:function(){return this.hasDeviceType("Mac")},isComputer:function(){return this.hasDeviceType("computer")},isPhone:function(){return this.hasDeviceType("phone")},isTablet:function(){return this.hasDeviceType("tablet")},isMobile:function(){return this.isPhone()||this.isTablet()},hasDeviceType:function(e){return-1!==this.getDeviceType().indexOf(e)},getDeviceType:function(){localStorage.deviceType;var e=[],t=navigator.userAgent;return t.match(/iPad/g)?(e.push("iOS"),e.push("iPad"),e.push("tablet")):t.match(/iPhone/g)?(e.push("iOS"),e.push("iPhone"),e.push("phone")):t.match(/Mac/g)?(e.push("Mac"),e.push("computer")):t.match(/Android/g)?(e.push("Android"),t.match(/Mobile/g)?e.push("phone"):e.push("tablet")):(e.push("PC"),e.push("computer")),localStorage.deviceType=JSON.stringify(e),e},setHTMLDevices:function(){var e=this.getDeviceType(),t=document.body;t.className=e.join(" ")},getStylesheet:function(){for(var e=0,t=0;t<document.styleSheets.length;t++)if(document.styleSheets[t].href&&document.styleSheets[t].href.indexOf("total.css")){e=t;break}return document.styleSheets[e]},getStylesheetRules:function(){var e=this.getStylesheet();if(!e)return{};var t=e.cssRules||e.rules;return t},getCSSVars:function(){var e=this.getStylesheetRules(),t=e[e.length-1],i=this.removeQuotes(t.style.content);return JSON.parse(i)},removeQuotes:function(e){return("string"==typeof e||e instanceof String)&&(e=e.replace(/^['"]+|\s+|\\|(;\s?})+|['"]$/g,"")),e}},new e}),n("helpers",[],function(){return{parentEleWithClassname:function(e,t){return null!=e&&e.classList?e.classList.contains(t)?e:this.parentEleWithClassname(e.parentNode,t):!1},parentEleIsElement:function(e,t){return null==e?!1:e==t?e:this.parentEleIsElement(e.parentNode,t)},screenToWorld:function(e,t,i){return{x:(t-e.offsetX)/e.scale,y:(i-e.offsetY)/e.scale}},worldToScreen:function(e,t,i){return{x:t*e.scale+e.offsetX,y:i*e.scale+e.offsetY}},getGuid:function(){return"T^"+Date.now()+Math.round(1e6*Math.random())},isLocalGuid:function(e){return 0===e.indexOf("T^")},clone:function(e){var t={};for(var i in e)t[i]=e[i];return t},cloneArray:function(e){for(var t=e.slice(0),i=0;i<e.length;i++)"object"==typeof e[i]&&(t[i]=this.cloneArray(e[i]));return t}}}),n("class",[],function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;return this.Class=function(){},Class.extend=function(i){function n(){!e&&this.init&&this.init.apply(this,arguments)}var s=this.prototype;e=!0;var o=new this;e=!1;for(var r in i)o[r]="function"==typeof i[r]&&"function"==typeof s[r]&&t.test(i[r])?function(e,t){return function(){var i=this._super;this._super=s[e];var n=t.apply(this,arguments);return this._super=i,n}}(r,i[r]):i[r];return n.prototype=o,n.prototype.constructor=n,n.extend=arguments.callee,n},this.Class}),n("gauth",["class","event"],function(e,t){var i=e.extend({CLIENT_ID:"450627732299-2d7jlo96ious5jmdmsd9t7hpclstf7ub.apps.googleusercontent.com",INSTALL_SCOPE:"https://www.googleapis.com/auth/drive.install",DRIVE_SCOPE:"https://www.googleapis.com/auth/drive",OPENID_SCOPE:"openid",_user:null,_authenticated:null,init:function(){this._authenticated=!1,t.addListener("onlineStatusChanged",function(e){e.online&&(console.log("Starting auth"),this.start())}.bind(this))},start:function(){this.authorize()},authorize:function(){gapi.auth.authorize({client_id:this.CLIENT_ID,scope:[this.INSTALL_SCOPE,this.DRIVE_SCOPE,this.OPENID_SCOPE],immediate:!0},this._handleAuthResult.bind(this))},_handleAuthResult:function(e){if(e&&!e.error){this._setStatus(!0);var t=1e3*(parseInt(e.expires_in)-600);setTimeout(function(){console.log("Refreshing GAuth token"),this.authorize()}.bind(this),t)}else this._setStatus(!1)},authorizeWithPopup:function(){gapi.auth.authorize({client_id:this.CLIENT_ID,scope:[this.INSTALL_SCOPE,this.DRIVE_SCOPE,this.OPENID_SCOPE],immediate:!1},this._handleAuthResult.bind(this))},isAuthenticated:function(){return this._authenticated},_setStatus:function(e){this._authenticated!=e&&(this._authenticated=e,t.trigger("authenticatedStatusChanged",{authenticated:e}))}});return new i}),n("online",["event"],function(e){var t=function(){this.init()};return t.prototype={_online:null,_script:null,_retryDelay:3e3,init:function(){this._script=document.getElementById("gapiScript"),window.addEventListener("online",this._onlineEvent.bind(this)),window.addEventListener("offline",this._offlineEvent.bind(this))},gapiLoaded:function(){console.log("Gapi loaded"),gapi.load("auth:client,drive-realtime,drive-share",function(){this._setStatus(!0)}.bind(this))},gapiLoadError:function(){console.warn("Failed to load gapi"),this._setStatus(!1),window.setTimeout(this._retryScript.bind(this),this._retryDelay)},isOnline:function(){return!!this._online},_retryScript:function(){navigator.onLine?(console.log("Retrying to load gapi"),this._reloadScript()):window.setTimeout(this._retryScript.bind(this),this._retryDelay)},_reloadScript:function(){var e=this._script.parentElement;e.removeChild(this._script);var t=document.createElement("script");t.onError=this._script.onError,t.async=this._script.async,t.id=this._script.id,t.type=this._script.type,t.src=this._script.src,this._script=t,e.insertBefore(this._script,e.children[0])},_onlineEvent:function(){window.gapi?this._setStatus(!0):this._reloadScript()},_offlineEvent:function(){this._setStatus(!1)},_setStatus:function(t){this._online!=t&&(this._online=t,e.trigger("onlineStatusChanged",{online:t}))},waitToComeOnline:function(t){return new Promise(function(i,n){function s(t){t.online&&(window.clearTimeout(r),e.removeListener("onlineStatusChanged",s),i())}function o(){e.removeListener("onlineStatusChanged",s),n()}if(this.isOnline())return i(),void 0;var r=null;e.addListener("onlineStatusChanged",s),r=window.setTimeout(o,t)}.bind(this))}},new t}),n("sequentialHelper",["event"],function(e){function t(){this.init()}return t.prototype={_runningActions:null,_openFiles:null,init:function(){this._runningActions={},this._openFiles=0,e.addListener("fileIdChanged",this._fileIdChanged.bind(this))},startLockedAction:function(e,t){this._runningActions[e]||(this._runningActions[e]=[],this._openFiles++);var i={promise:null,resolve:null,reject:null},n=new Promise(function(e,t){i.resolve=e,i.reject=t});return i.promise=n,"global"!=e&&this._runningActions.global&&!t||0!=this._runningActions[e].length||i.resolve(),this._runningActions[e].push(i),i.promise},endLockedAction:function(e){return this._runningActions[e].shift(),0==this._runningActions[e].length?(delete this._runningActions[e],this._openFiles--,1==this._openFiles&&this._runningActions.global&&this._runningActions.global[0].resolve(),void 0):(this._runningActions[e][0].resolve(),void 0)},startGlobalAction:function(){return this.startLockedAction("global")},endGlobalAction:function(){this.endLockedAction("global");for(var e in this._runningActions)this._runningActions[e][0].resolve()},hasActions:function(){return 0!=this._openFiles},_fileIdChanged:function(e){this._runningActions[e.oldId]&&(this._runningActions[e.newId]=this._runningActions[e.oldId],delete this._runningActions[e.oldId])}},new t}),n("bezierCurve",[],function(){function e(){this.init()}return e.prototype={_rhs:null,_controlPoints:null,_tmp:null,_length:null,init:function(){this._length=0,this._rhs=[[],[]],this._controlPoints=[],this._tmp=[];for(var e=0;2e3>e;e++)this._tmp[e]=1,this._rhs[0][e]=1,this._rhs[1][e]=1},getCurveControlPoints:function(e){var t=e.length-1;if(this._length=t,this._controlPoints.length=t,1>t)return console.error("Must have at least two knots"),void 0;if(1==t){var i=[(2*e[0][0]+e[1][0])/3,(2*e[0][1]+e[1][1])/3],n=[2*i[0]-e[0][0],2*i[1]-e[0][1]];return[[i,n]]}this._rhs[0][0]=e[0][0]+2*e[1][0],this._rhs[1][0]=e[0][1]+2*e[1][1];for(var s=1;t-1>s;++s)this._rhs[0][s]=4*e[s][0]+2*e[s+1][0],this._rhs[1][s]=4*e[s][1]+2*e[s+1][1];this._rhs[0][t-1]=(8*e[t-1][0]+e[t][0])/2,this._rhs[1][t-1]=(8*e[t-1][1]+e[t][1])/2,this.getFirstControlPoints(this._rhs);for(var s=0;t>s;++s)"undefined"==typeof this._controlPoints[s]&&(this._controlPoints[s]=[new Array(2),new Array(2)]),this._controlPoints[s][0][0]=this._rhs[0][s],this._controlPoints[s][0][1]=this._rhs[1][s],t-1>s?(this._controlPoints[s][1][0]=2*e[s+1][0]-this._rhs[0][s+1],this._controlPoints[s][1][1]=2*e[s+1][1]-this._rhs[1][s+1]):(this._controlPoints[s][1][0]=(e[t][0]+this._rhs[0][t-1])/2,this._controlPoints[s][1][1]=(e[t][1]+this._rhs[1][t-1])/2);return this._controlPoints},getFirstControlPoints:function(){var e=this._length,t=2;this._rhs[0][0]/=t,this._rhs[1][0]/=t;for(var i=1;e>i;i++)this._tmp[i]=1/t,t=e-1>i?4-this._tmp[i]:3.5-this._tmp[i],this._rhs[0][i]-=this._rhs[0][i-1],this._rhs[0][i]/=t,this._rhs[1][i]-=this._rhs[1][i-1],this._rhs[1][i]/=t;for(var i=e-1;i>=0;i--)this._rhs[0][i-1]-=this._tmp[i]*this._rhs[0][i],this._rhs[1][i-1]-=this._tmp[i]*this._rhs[1][i]}},new e}),n("components/drawCanvas",["class","helpers","bezierCurve"],function(e,t){var i=e.extend({_canvas:null,_ctx:null,_settings:null,_tempCanvas:null,_tempCtx:null,_useCurves:null,init:function(e,t){this._canvas=e,this._ctx=e.getContext("2d"),this._settings=t,this._useCurves=!0,this._backCanvas=document.createElement("canvas"),this._backCtx=this._backCanvas.getContext("2d"),this._tempCanvas=document.createElement("canvas"),this._tempCtx=this._tempCanvas.getContext("2d")},useCurves:function(e){this._useCurves=e},doAll:function(e){this._backCanvas.width=this._canvas.width,this._backCanvas.height=this._canvas.height,this._clearCanvas(this._backCanvas,this._backCtx),this._clearCanvas(this._tempCanvas,this._tempCtx);for(var t=0;t<e.length;t++){var i=e[t];this._doAction(this._backCtx,i)}},doTemporaryAction:function(e){this._tempCanvas.width=this._canvas.width,this._tempCanvas.height=this._canvas.height,this._clearCanvas(this._tempCanvas,this._tempCtx),this._doAction(this._tempCtx,e)},addAction:function(e){this._doAction(this._backCtx,e),this._clearCanvas(this._tempCanvas,this._tempCtx)},clear:function(){this._clearCanvas(this._canvas,this._ctx)},_clearCanvas:function(e,i){i.setTransform(this._settings.scale,0,0,this._settings.scale,this._settings.offsetX,this._settings.offsetY);var n=t.screenToWorld(this._settings,0,0),s=t.screenToWorld(this._settings,e.width,e.height);i.clearRect(n.x,n.y,s.x-n.x,s.y-n.y)},render:function(){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.drawImage(this._backCanvas,0,0,this._backCanvas.width,this._backCanvas.height),this._ctx.drawImage(this._tempCanvas,0,0,this._tempCanvas.width,this._tempCanvas.height)},_doAction:function(e,t){"stroke"==t.type&&this._drawStroke(e,t.value)},updateSettings:function(e){this._settings=e},_drawStroke:function(e,t){if(!(t.points.length<2)){var i=t.controlPoints,n=t.points,s=n[0],o=t.width;t.lockWidth&&(o/=this._settings.scale),e.lineJoin="round",e.lineWidth=o,e.strokeStyle=t.color,e.lineCap="round",e.beginPath(),e.moveTo(s.x,s.y);for(var r=1;r<n.length;r++)if(s=n[r],this._useCurves||1==r){var a=i[r-1][0],c=i[r-1][1];e.bezierCurveTo(a[0],a[1],c[0],c[1],s[0],s[1])}else e.lineTo(s[0],s[1]);e.stroke()}}});return i}),n("components/manipulateCanvas",["components/drawCanvas","helpers"],function(e,t){var i=e.extend({zoom:function(e,i,n){if(this._settings.scale+n<.001||this._settings.scale+n>2e4)return!1;var s=t.screenToWorld(this._settings,e,i);this._settings.scale+=n;var o=t.worldToScreen(this._settings,s.x,s.y),r={x:e-o.x,y:i-o.y};return this._settings.offsetX+=r.x,this._settings.offsetY+=r.y,!0},pan:function(e,t){return this._settings.offsetX+=e,this._settings.offsetY+=t,!0},panTo:function(e,t){this._settings.offsetX=e,this._settings.offsetY=t}});return i}),n("components/thumbnail",["class","globals","helpers","components/manipulateCanvas"],function(e,t,i,n){var s=e.extend({_canvas:null,_thumbnailWidth:null,_thumbnailHeight:null,init:function(){var e=document.createElement("canvas");this.setThumbnailSizes(),e.width=this._thumbnailWidth,e.height=this._thumbnailHeight,this._canvas=e},render:function(e,t){var s=new n(this._canvas,e),o={x:window.innerWidth/2,y:window.innerHeight/2},r=i.screenToWorld(e,o.x,o.y),a=Math.min(this._canvas.width/window.innerWidth,this._canvas.height/window.innerHeight),c=e.scale*a-e.scale;s.zoom(0,0,c);var l={x:this._canvas.width/2,y:this._canvas.height/2},u=i.worldToScreen(e,r.x,r.y),h={x:l.x-u.x,y:l.y-u.y};return s.pan(h.x,h.y),s.doAll(t),s.render(),this._canvas.toDataURL("image/png")},setThumbnailSizes:function(){var e=15,i=200,n=300;t.isComputer()?(e=15,i=200,n=300):t.isTablet()?(e=15,i=200,n=330):t.isPhone()&&(e=10,i=100,n=160);var s=t.getStylesheet();if(s){var o=t.getStylesheetRules(),r=[];r.push("#files-list { padding-top: "+e+"px !important; }"),r.push("#files-list li {width: "+n+"px;"+"padding: 0px "+e/2+"px "+e+"px "+e/2+"px;"+"}"),r.push("#files-list .create .icon { font-size: "+.5*i+"px; }"),r.push("#files-list .create, #files-list .thumbnail, #files-list .overlay, #files-list .thumbnail-info {height: "+i+"px !important;"+"}"),r.forEach(function(e){s.insertRule(e,o.length)})}this._thumbnailHeight=i*window.devicePixelRatio,this._thumbnailWidth=n*window.devicePixelRatio}});return new s}),n("dataLayer/file",["class","event","helpers","sequentialHelper","bezierCurve","components/thumbnail"],function(e,t,i,n,s,o){var r=e.extend({fileInfoPromise:null,_cachedActions:null,_backing:null,_driveBacking:null,_addedCallback:null,_removedCallback:null,_syncPromise:null,init:function(e){this._backing=e},hasLocalActions:function(e){return this._backing.load(e).then(function(){return this._backing.getActions()}.bind(this)).then(function(e){return this._backing.close().then(function(){return 0!==e.local.length})}.bind(this))},remoteActionsMatch:function(e,t){return Promise.all([this._backing.load(e),t.load(e)]).then(function(){var e=this._backing.getActions(),i=t.getActions();return Promise.all([e,i]).then(function(e){var t=e[0],i=e[1];if(t.remote.length!=i)return!1;for(var n=0;n<t.remote.length;n++)if(t.remote[n].id!=i[n])return!1;return!0})}.bind(this))},load:function(e){var t=this._backing.load(e);return t.then(function(){return this._backing.getActions()}.bind(this)).then(function(e){var i={remoteActions:[],localActions:[],redoStack:[]};return i.remoteActions=e.remote,i.localActions=e.local,this._cachedActions=i,this.fileInfoPromise=t,this}.bind(this))},create:function(e){return this._backing.create(e).then(function(){return this.load(e.id)}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},rename:function(e){return this.fileInfoPromise.then(function(i){var s=Date.now();i.name=e,i.localModifiedTime=s,t.trigger("fileRenamed",i),t.trigger("fileModified",i),this.fileInfoPromise=Promise.resolve(i);var o=[];return o.push(this.fileInfoPromise.then(function(){return this._backing.updateLocalModifiedTime(s)}.bind(this))),o.push(this._backing.rename(e)),this._driveBacking&&o.push(n.startLockedAction(i.id).then(function(){return this._driveBacking.rename(e)}.bind(this)).catch(function(e){console.error(e)}).then(function(){n.endLockedAction(i.id)}.bind(this))),Promise.all(o)}.bind(this))},startDrive:function(e){return console.log("starting"),e.listen(this.remoteActionsAdded.bind(this),this.remoteActionsRemoved.bind(this)),this.fileInfoPromise.then(function(t){return console.log("Starting drive for file",t.id),this.sync(e,!0)}.bind(this)).then(function(){this._driveBacking=e}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},sync:function(e,i){var s=this._driveBacking||e;return this._syncPromise=this.fileInfoPromise.then(function(e){return s._parent.getFileInfo(e.id).catch(function(){return void 0}).then(function(o){console.log("Starting file sync",e.id);var r=[];if(void 0!==o)console.log("Found file",e.id,"on drive"),o.title!=e.name&&(o.driveModifiedTime==e.driveModifiedTime?r.push(s.load(e.id).then(function(){return s.rename(e.name)}.bind(this))):r.push(this.rename(o.title))),i&&r.push(this._syncRemoteActionsFromDrive(s));else{console.log("File not found on drive",e.id);var a=e.id;r.push(n.startLockedAction(a,!0).then(function(){return s.create(e)}).then(function(i){return this._backing.replaceFileId(i.id).then(function(){return this.load(i.id)}.bind(this)).then(function(){return this._moveSettings(a)}.bind(this)).then(function(){t.trigger("fileIdChanged",{oldId:a,newId:i.id})}).then(function(){return this._backing.getActions()}.bind(this)).then(function(e){var t=e.remote.concat(e.local);return this._sendAllActions(t,s)}.bind(this)).then(function(){return s.rename(e.name)}.bind(this)).catch(function(e){console.error(e)}.bind(this)).then(function(){n.endLockedAction(i.id)})}.bind(this)))}return Promise.all(r)}.bind(this))}.bind(this)).then(function(){this._syncPromise=null}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)}).then(function(){return this.fileInfoPromise}.bind(this)).then(function(e){console.log("Completed file sync",e.id)}),this._syncPromise},listen:function(e,t){this._addedCallback=e,this._removedCallback=t},stopListening:function(){this._addedCallback=null,this._removedCallback=null},getActions:function(){return this._cachedActions.remoteActions.concat(this._cachedActions.localActions)},localSettings:function(e){return this.fileInfoPromise.then(function(t){return e&&(localStorage[t.id]=JSON.stringify(e)),localStorage[t.id]||(localStorage[t.id]=JSON.stringify({offsetX:0,offsetY:0,scale:1,color:"#000",tools:{point:"pencil",gesture:null,scroll:"pan"}})),JSON.parse(localStorage[t.id])}.bind(this))},_moveSettings:function(e){return localStorage[e]?this.fileInfoPromise.then(function(t){localStorage[t.id]=localStorage[e],delete localStorage[e]}):Promise.resolve()},undo:function(){if(this._driveBacking)return this._driveBacking.undo();if(0===this._cachedActions.localActions.length)return Promise.resolve(!1);var e=this._cachedActions.localActions.pop();return this._cachedActions.redoStack.push(e),this._backing.removeLocalAction(e.id).then(function(){return this.fileInfoPromise}.bind(this)).then(function(e){return e.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(e),t.trigger("fileModified",e),this._backing.updateLocalModifiedTime(e.localModifiedTime)}.bind(this))},redo:function(){if(this._driveBacking)return this._driveBacking.redo();if(0===this._cachedActions.redoStack.length)return Promise.resolve(!1);var e=this._cachedActions.redoStack.pop();return this._addAction(e)},addAction:function(e){return this._cachedActions.redoStack.length=0,this._addAction(e)},_addAction:function(e){this._cachedActions.localActions.push(e);var n=[];if(n.push(this.fileInfoPromise.then(function(e){return e.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(e),t.trigger("fileModified",e),this._backing.updateLocalModifiedTime(e.localModifiedTime)}.bind(this))),n.push(this._backing.addLocalAction(e)),this._driveBacking){var s=this._prepareForDrive(i.clone(e));n.push(this._driveBacking.addAction(s))}return Promise.all(n).then(function(){return this.fileInfoPromise}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},"delete":function(){return this.fileInfoPromise.then(function(e){return this.close().then(function(){return delete localStorage[e.id],this._backing._parent.deleteFile(e.id)}.bind(this))}.bind(this))},close:function(){var e=Promise.resolve();return this._syncPromise&&(e=this._syncPromise),this.fileInfoPromise?e.then(function(){this.fileInfoPromise.then(function(){this._cachedActions.length=0,this.fileInfoPromise=Promise.reject(new Error("File has been closed"))}.bind(this));var e=[];return e.push(this._backing.close()),this._driveBacking&&(this._driveBacking.stopListening(),e.push(this._driveBacking.close()),this._driveBacking=null),Promise.all(e)}.bind(this)):e},_syncRemoteActionsFromDrive:function(e){function t(e,t){if(e.length!=t.length)return!1;for(var i=0;i<e.length;i++)if(e[i].id!=t[i].id)return!1;return!0}return this.fileInfoPromise.then(function(t){var i=e.load(t.id).then(function(){return e.getActions()}.bind(this)),n=this._backing.getActions();return Promise.all([t,i,n])}.bind(this)).then(function(i){for(var n=i[0],s=i[1],o=i[2],r=[],a=s.length<o.remote.length?s:o.remote,c=-1,l=0;l<a.length;l++)if(s[l].id!=o.remote[l].id){c=l;break}var u,h=!1;if(-1!==c||s.length!=o.remote.length){if(console.log("Differences between remote and local actions",n.id),h=!0,-1!=c){var d=s.slice(c);u=this._indexify(d,c),u=u.map(this._convertFromDrive),r.push(this._backing.removeRemoteActions(c,o.remote.length-c).then(function(){this._backing.addRemoteActions(c,u)}.bind(this))),this._cachedActions.remoteActions.splice.apply(this._cachedActions.remoteActions,[c,this._cachedActions.remoteActions.length-c].concat(u))}else if(a==s)r.push(this._backing.removeRemoteActions(s.length,o.remote.length-s.length)),this._cachedActions.remoteActions.splice(s.length,o.remote.length-s.length);else{var f=s.slice(o.remote.length);u=this._indexify(f,o.remote.length),u=u.map(this._convertFromDrive),r.push(this._backing.addRemoteActions(o.remote.length,u)),this._cachedActions.remoteActions.splice.apply(this._cachedActions.remoteActions,[this._cachedActions.remoteActions.length,0].concat(u))}!t(this._cachedActions.remoteActions,s)}return r.push(this._sendAllActions(o.local,e)),Promise.all(r).then(function(){return h?this.updateThumbnail():void 0}.bind(this))}.bind(this))},_sendAllActions:function(e,t){for(var i=[],n=0;n<e.length;n++){var s=this._prepareForDrive(e[n]);i.push(t.addAction(s))}return Promise.all(i)},remoteActionsAdded:function(e){!this.isConnected();var i=[];if(e.isLocal)for(var n=0;n<e.values.length;n++){for(var s=0;s<this._cachedActions.localActions.length;s++)if(this._cachedActions.localActions[s].id==e.values[n].id){this._cachedActions.localActions.splice(s,1);break}i.push(this._backing.removeLocalAction(e.values[n].id))}this._cachedActions.remoteActions.splice.apply(this._cachedActions.remoteActions,[e.index,0].concat(e.values));var o=this._indexify(e.values,e.index);return o=o.map(this._convertFromDrive),i.push(this._backing.addRemoteActions(e.index,o)),this._addedCallback&&this._addedCallback({isLocal:e.isLocal,items:o}),i.push(this.fileInfoPromise.then(function(i){return e.isLocal?t.trigger("fileModified",i):t.trigger("fileModifiedRemotely",i),i.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(i),this._backing.updateLocalModifiedTime(i.localModifiedTime)}.bind(this))),Promise.all(i).catch(function(){}).then(function(){return this.updateThumbnail()}.bind(this))},remoteActionsRemoved:function(e){!this.isConnected(),this._cachedActions.remoteActions.splice(e.index,e.values.length);var i=[];return i.push(this._backing.removeRemoteActions(e.index,e.values.length)),this._removedCallback&&i.push(this._removedCallback()),i.push(this.fileInfoPromise.then(function(e){return e.localModifiedTime=Date.now(),this.fileInfoPromise=Promise.resolve(e),t.trigger("fileModified",e),this._backing.updateLocalModifiedTime(e.localModifiedTime)})),Promise.all(i).then(function(){return this.updateThumbnail()}.bind(this))},updateDriveModifiedTime:function(e){return this._backing.updateDriveModifiedTime(e)},updateThumbnail:function(){return this.localSettings().then(function(e){var i=o.render(e,this.getActions());
return this.fileInfoPromise.then(function(e){return e.thumbnail=i,t.trigger("thumbnailUpdated",e),this.fileInfoPromise=Promise.resolve(e),this._backing.updateThumbnail(i)}.bind(this))}.bind(this))},_indexify:function(e,t){for(var n=[],s=0;s<e.length;s++){var o=i.clone(e[s]);o.index=s+t,n.push(o)}return n},_prepareForDrive:function(e){var t=i.clone(e);return t.value=i.clone(e.value),delete t.value.controlPoints,t},_convertFromDrive:function(e){var t=s.getCurveControlPoints(e.value.points);return e.value.controlPoints=i.cloneArray(t),void 0==e.value.controlPoints,e},isConnected:function(){return!!this._driveBacking}});return r}),n("dataLayer/data",["class","helpers","event","gauth","online","sequentialHelper","dataLayer/file"],function(e,t,i,n,s,o,r){var a=e.extend({_backing:null,_cachedFiles:null,_fileReferences:null,_driveBacking:null,init:function(e,t){this._cachedFiles={},this._fileReferences={},this._backing=e,this._driveBacking=t,i.addListener("fileIdChanged",this._fileIdChanged.bind(this))},getFiles:function(){return this._backing.getFiles().catch(function(e){throw console.error(e,e.stack,e.message),e})},createFile:function(){var e={id:t.getGuid(),name:"Untitled File",localModifiedTime:Date.now(),driveModifiedTime:"",thumbnail:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg=="};return this._createFile(e)},_createFile:function(e){var t=new r(new this._backing.instance(this._backing));return this._fileReferences[e.id]=1,this._cachedFiles[e.id]=t.create(e).then(function(e,t){return i.trigger("fileAdded",e),t}.bind(this,e)).catch(function(e){throw console.error(e,e.stack,e.message),e}),n.isAuthenticated()&&this._cachedFiles[e.id].then(function(){t.startDrive(this._newDriveInstance())}.bind(this)),this._cachedFiles[e.id]},loadFile:function(e,t){return this._cachedFiles[e]?(this._fileReferences[e]++,this._cachedFiles[e]):this.fileExists(e).then(function(i){if(!i)throw new Error("This file does not exist");var n=new r(new this._backing.instance(this._backing));return this._fileReferences[e]=1,this._cachedFiles[e]=n.load(e).then(function(){return n}.bind(this)),s.isOnline()&&this._cachedFiles[e].then(function(){var e=n.startDrive(this._newDriveInstance());return t?e:void 0}.bind(this)),this._cachedFiles[e]}.bind(this))},deleteFile:function(e,s){var o=[];if(i.trigger("fileRemoved",e),this._fileReferences[e]&&delete this._fileReferences[e],this._cachedFiles[e]){var r=this._cachedFiles[e];delete this._cachedFiles[e],o.push(r.then(function(e){return this.close(e)}.bind(this)))}return t.isLocalGuid(e)?this._backing.deleteFile(e):!s&&n.isAuthenticated()?this._driveBacking.deleteFile(e).then(function(){return this._backing.deleteFile(e)}.bind(this)):this._backing.markFileAsDeleted(e)},close:function(e){return e.fileInfoPromise.then(function(t){return this._fileReferences[t.id]&&this._fileReferences[t.id]--,this._fileReferences[t.id]>0?Promise.resolve():(delete this._fileReferences[t.id],delete this._cachedFiles[t.id],e.close())}.bind(this))},syncOpenFiles:function(){var e=Promise.resolve();for(var t in this._cachedFiles){var i=this._cachedFiles[t];e=e.then(function(e){return e}.bind(this,i)).then(function(e){var t=new this._driveBacking.instance(this._driveBacking);return e.startDrive(t)}.bind(this))}return e},openReferences:function(e){return this._fileReferences[e]?this._fileReferences[e]:0},_fileIdChanged:function(e){this._cachedFiles[e.oldId]&&(this._fileReferences[e.newId]=this._fileReferences[e.oldId],delete this._fileReferences[e.oldId],this._cachedFiles[e.newId]=this._cachedFiles[e.oldId],delete this._cachedFiles[e.oldId])},_newDriveInstance:function(){return new this._driveBacking.instance(this._driveBacking)},checkForUpdates:function(){function e(e){return e.id}function t(e,t){return e.id<t.id}function i(e,t){return e.id==t.id}function s(e,t,i){for(var n=[],s=0;s<e.length;s++)for(var o=0;o<t.length;o++)if(c(e[s],t[o],i)){n.push({drive:e[s],local:t[o]});break}return n}function a(e,t,i){for(var n=[],s=0;s<e.length;s++){for(var o=!1,r=0;r<t.length;r++)if(i(e[s],t[r])){o=!0;break}o||n.push(e[s])}return n}function c(e,t,i){return i(e,t)}return n.isAuthenticated()?o.hasActions()?(console.warn("Actions currently running, can't sync"),Promise.reject()):o.startGlobalAction().then(function(){console.log("Checking for file updates on drive");var n=this._driveBacking.getFiles(),o=this._backing.getFiles(),c=this._backing.getDeletedFiles();return Promise.all([n,o,c]).then(function(n){var o=n[0].sort(t),c=n[1].sort(t),l=n[2].sort(t);c.map(e);var u=o.map(e),h=l.map(e),d=h.filter(function(e){return-1===u.indexOf(e)}),f=a(o,c,i),m=a(c,o,i),_=s(o,c,i),v=[],p=Promise.resolve();return d.map(function(e){v.push(this._backing.deleteFile(e))}.bind(this)),p=f.reduce(function(e,t){return e.then(function(e){var t=-1!==h.indexOf(e.id);return this._fileNotFoundLocally(e,t)}.bind(this,t))}.bind(this),p),p=m.reduce(function(e,t){return e.then(function(e){var t=-1!==h.indexOf(e.id);return this._fileNotFoundOnRemote(e,t)}.bind(this,t))}.bind(this),p),p=_.reduce(function(e,t){return e.then(function(e){var t=e.drive,i=e.local,n=new r(new this._backing.instance(this._backing)),s=n.hasLocalActions(i.id);return s.then(function(e){return t.modifiedDate!=i.driveModifiedTime||e||t.title!=i.name?this.loadFile(i.id,!0).then(function(e){return e.updateDriveModifiedTime(t.modifiedDate).then(function(){return this.close(e)}.bind(this))}.bind(this)):(console.log("No local changes, skipping",i.id),void 0)}.bind(this))}.bind(this,t))}.bind(this),p),v.push(p),Promise.all(v)}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)}).then(function(){console.log("Completed checking for Drive updates")}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})}.bind(this)).then(function(){o.endGlobalAction()}):Promise.resolve()},_fileNotFoundLocally:function(e,t){if(t){console.log(e.id,"was deleted");var i=new r(new this._backing.instance(this._backing));return i.remoteActionsMatch(e.id,this._newDriveInstance()).then(function(t){if(t)return console.log("Deleting",e.id,"on remote"),this.deleteFile(e.id);console.log("Readding",e.id,"on remote");var i=this.loadFile(e.id).then(function(e){return this.close(e)}.bind(this));return Promise.all([this._backing.unmarkFileAsDeleted(e.id),i])}.bind(this))}return this._createFileFromRemote(e)},_fileNotFoundOnRemote:function(e,i){if(i)return this.deleteFile(e.id,!0);var n=!t.isLocalGuid(e.id);return n?this.deleteFile(e.id,!0):this.loadFile(e.id,!0).then(function(e){return this.close(e)}.bind(this))},getRemoteFileInfo:function(e){return this.isReadableRemoteFile(e).then(function(t){if(t)return this._driveBacking.getFileInfo(e);throw"File does not exist or is not readable"}.bind(this))},loadFileFromRemote:function(e){return this.getRemoteFileInfo(e).then(function(t){return Promise.all([this._driveBacking.touchFile(e),this._createFileFromRemote(t)]).then(function(e){return e[1]})}.bind(this))},_createFileFromRemote:function(e){var t={id:e.id,name:e.title,localModifiedTime:Date.now(),driveModifiedTime:e.modifiedDate,thumbnail:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg=="};return this._createFile(t).then(function(e){return this.close(e)}.bind(this)).then(function(){return t}.bind(this))},isReadableRemoteFile:function(e){return s.isOnline()?this._driveBacking.canReadFile(e):Promise.reject(new Error("Not connected to drive"))},clearLocal:function(){return this._backing.clearAll().then(function(){this._backing.init()}.bind(this))},fileExists:function(e){return this._backing.fileExists(e)}});return a}),n("db",[],function(){var e=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB,t=window.IDBKeyRange||window.webkitIDBKeyRange,i={readonly:"readonly",readwrite:"readwrite"},n=Object.prototype.hasOwnProperty;if(e){var s=function(e){return e},o=function(){var e,t=[],i=function(i,n){if(t){n=n||[],e=e||[i,n];for(var s=0,o=t.length;o>s;s++)t[s].apply(e[0],e[1]);t=[]}};this.add=function(){for(var n=0,s=arguments.length;s>n;n++)t.push(arguments[n]);return e&&i(),this},this.execute=function(){return i(this,arguments),this}},r=function(e){var t="progress",i=[["resolve","done",new o,"resolved"],["reject","fail",new o,"rejected"],["notify","progress",new o]],n={},s={state:function(){return t},then:function(){var e=arguments;return r(function(t){i.forEach(function(i,s){var o=e[s];n[i[1]]("function"==typeof o?function(){var e=o.apply(this,arguments);e&&"function"==typeof e.promise&&e.promise().done(t.resolve).fail(t.reject).progress(t.notify)}:t[i[0]])})}).promise()},promise:function(e){return e?(Object.keys(s).forEach(function(t){e[t]=s[t]}),e):s}};return i.forEach(function(e){var i=e[2],o=e[3];s[e[1]]=i.add,o&&i.add(function(){t=o}),n[e[0]]=i.execute}),s.promise(n),e&&e.call(n,n),n},a=function(e){var t=this,s=!1;this.add=function(n){if(s)throw new Error("Database has been closed");for(var o=[],a=0;a<arguments.length-1;a++)o[a]=arguments[a+1];var c=e.transaction(n,i.readwrite),l=c.objectStore(n),u=r();return o.forEach(function(e){var t;if(e.item&&e.key){var i=e.key;e=e.item,t=l.add(e,i)}else t=l.add(e);t.onsuccess=function(t){var i=t.target,n=i.source.keyPath;null===n&&(n="__id__"),Object.defineProperty(e,n,{value:i.result,enumerable:!0}),u.notify()}}),c.oncomplete=function(){u.resolve(o,t)},c.onerror=function(e){var t=new Error;t.dbError=e,e.records=o,u.reject(t)},c.onabort=function(e){var t=new Error;t.dbError=e,e.records=o,u.reject(t)},u.promise()},this.update=function(n){if(s)throw new Error("Database has been closed");for(var o=[],a=0;a<arguments.length-1;a++)o[a]=arguments[a+1];var c=e.transaction(n,i.readwrite),l=c.objectStore(n),u=(l.keyPath,r());return o.forEach(function(e){var t;if(e.item&&e.key){var i=e.key;e=e.item,t=l.put(e,i)}else t=l.put(e);t.onsuccess=function(){u.notify()}}),c.oncomplete=function(){u.resolve(o,t)},c.onerror=function(e){var t=new Error;t.dbError=e,e.records=o,u.reject(t)},c.onabort=function(e){var t=new Error;t.dbError=e,e.records=o,u.reject(t)},u.promise()},this.remove=function(t,n){if(s)throw new Error("Database has been closed");var o=e.transaction(t,i.readwrite),a=o.objectStore(t),c=r();return a.delete(n),o.oncomplete=function(){c.resolve(n)},o.onerror=function(e){var t=new Error;t.dbError=e,c.reject(t)},c.promise()},this.clear=function(t){if(s)throw new Error("Database has been closed");var n=e.transaction(t,i.readwrite),o=n.objectStore(t),a=r();return o.clear(),n.oncomplete=function(){a.resolve()},n.onerror=function(e){var t=new Error;t.dbError=e,a.reject(t)},a.promise()},this.close=function(){if(s)throw new Error("Database has been closed");e.close(),s=!0},this.get=function(t,i){if(s)throw new Error("Database has been closed");var n=e.transaction(t),o=n.objectStore(t),a=r(),c=o.get(i);return c.onsuccess=function(e){a.resolve(e.target.result)},n.onerror=function(e){var t=new Error;t.dbError=e,a.reject(t)},a.promise()},this.query=function(t,i){if(s)throw new Error("Database has been closed");return new c(t,e,i)};for(var o=0,a=e.objectStoreNames.length;a>o;o++)!function(e){t[e]={};for(var i in t)n.call(t,i)&&"close"!==i&&(t[e][i]=function(i){return function(){var n=[e].concat([].slice.call(arguments,0));return t[i].apply(t,n)}}(i))}(e.objectStoreNames[o])},c=function(e,n,o){var a=this,c=!1,l=!1,u=function(s,a,u,h,d,f,m){var _=n.transaction(e,c||l?i.readwrite:i.readonly),v=_.objectStore(e),p=o?v.index(o):v,g=s?t[s].apply(null,a):null,b=[],w=r(),y=[g],d=d?d:null,f=f?f:[],E=0;"count"!==u&&y.push(h||"next");var P=c?Object.keys(c):!1,A=function(e){for(var t=0;t<P.length;t++){var i=P[t],n=c[i];n instanceof Function&&(n=n(e)),e[i]=n}return e},T=l instanceof Function?l:!1;return p[u].apply(p,y).onsuccess=function(e){var t=e.target.result;if("number"==typeof t)b=t;else if(t)if(null!==d&&d[0]>E)E=d[0],t.advance(d[0]);else if(null!==d&&E>=d[0]+d[1]);else{var i=!0,n="value"in t?t.value:t.key;f.forEach(function(e){e&&e.length&&(i=2===e.length?n[e[0]]===e[1]:e[0].apply(void 0,[n]))}),i&&(E++,b.push(m(n)),c&&(n=A(n),t.update(n)),l&&T(n)&&t.delete(n)),t.continue()}},_.oncomplete=function(){w.resolve(b)},_.onerror=function(e){var t=new Error;t.dbError=e,w.reject(t)},_.onabort=function(e){var t=new Error;t.dbError=e,w.reject(t)},w.promise()},h=function(e,t){var i="next",n="openCursor",o=[],r=null,a=s,h=!1,d=function(){return u(e,t,n,h?i+"unique":i,r,o,a)},f=function(){return r=Array.prototype.slice.call(arguments,0,2),1==r.length&&r.unshift(0),{execute:d,modify:b,remove:w}},m=function(){return i=null,n="count",{execute:d}},_=function(){return n="openKeyCursor",{desc:p,execute:d,filter:v,distinct:g,map:y}},v=function(){return o.push(Array.prototype.slice.call(arguments,0,2)),{keys:_,execute:d,filter:v,desc:p,distinct:g,modify:b,remove:w,limit:f,map:y}},p=function(){return i="prev",{keys:_,execute:d,filter:v,distinct:g,modify:b,remove:w,map:y}},g=function(){return h=!0,{keys:_,count:m,execute:d,filter:v,desc:p,modify:b,remove:w,map:y}},b=function(e){return c=e,{execute:d}},w=function(e){return l="undefined"==typeof e?function(){return!0}:e,{execute:d}},y=function(e){return a=e,{execute:d,count:m,keys:_,filter:v,desc:p,distinct:g,modify:b,remove:w,limit:f,map:y}};return{execute:d,count:m,keys:_,filter:v,desc:p,distinct:g,modify:b,remove:w,limit:f,map:y}};"only bound upperBound lowerBound".split(" ").forEach(function(e){a[e]=function(){return new h(e,arguments)}}),this.filter=function(){var e=new h(null,null);return e.filter.apply(e,arguments)},this.all=function(){return this.filter()}},l=function(e,t,i){"function"==typeof t&&(t=t());for(var s in t){var o,r=t[s];o=!n.call(t,s)||i.objectStoreNames.contains(s)?e.currentTarget.transaction.objectStore(s):i.createObjectStore(s,r.key);for(var a in r.indexes)if(!o.indexNames.contains(a)){var c=r.indexes[a];o.createIndex(a,c.key||a,Object.keys(c).length?c:{unique:!1})}}},u=function(e,t){var i=e.target.result,n=new a(i,t),s=r();return s.resolve(n),s.promise()},h={version:"0.9.0",open:function(t){var i,n=r();return i=e.open(t.server,t.version),i.onsuccess=function(e){u(e,t.server,t.version,t.schema).done(n.resolve).fail(n.reject).progress(n.notify)},i.onupgradeneeded=function(e){l(e,t.schema,e.target.result)},i.onerror=function(e){var t=new Error;t.dbError=e,n.reject(t)},n.promise()}};return h}}),n("dataLayer/indexedDBBacking",["class","helpers","db","event"],function(e,t,i,n){var s=e.extend({_parent:null,_fileInfoPromise:null,_fileServerPromise:null,init:function(e){this._parent=e},load:function(e){return this._fileServerPromise=Promise.cast(i.open({server:e,version:2,schema:{localActions:{key:{keyPath:"id"}},remoteActions:{key:{keyPath:"id"},indexes:{id:{unique:!0},index:{unique:!0}}}}})),this._fileInfoPromise=this._parent.getFileInfo(e),Promise.all([this._fileServerPromise,this._fileInfoPromise]).then(function(e){return e[1]})},create:function(e){return this._parent._addFile(e).then(function(){return this.load(e.id)}.bind(this))},getActions:function(){return this._fileServerPromise.then(function(e){var t=Promise.cast(e.localActions.query().all().execute()),i=Promise.cast(e.remoteActions.query("index").all().execute());return Promise.all([t,i]).then(function(e){return{local:e[0],remote:e[1]}})}.bind(this))},rename:function(e){return this._fileInfoPromise.then(function(t){return this._parent._renameFile(t.id,e).then(function(e){this._fileInfoPromise=Promise.cast(e)})}.bind(this))},updateThumbnail:function(e){return this._fileInfoPromise.then(function(t){return this._parent._updateThumbnail(t.id,e)}.bind(this))},addLocalAction:function(e){return this._fileServerPromise.then(function(t){return Promise.cast(t.localActions.add(e))}.bind(this))},removeLocalAction:function(e){return this._fileServerPromise.then(function(t){return Promise.cast(t.localActions.remove(e))}.bind(this))},addRemoteActions:function(e,t){return this._fileServerPromise.then(function(i){return Promise.cast(i.remoteActions.query("index").lowerBound(e).desc().modify({index:function(e){return e.index+t.length}}).execute()).then(function(){return Promise.cast(i.remoteActions.add.apply(i.remoteActions,t))})}.bind(this))},removeRemoteActions:function(e,t){return this._fileServerPromise.then(function(i){return Promise.cast(i.remoteActions.query("index").lowerBound(e).limit(t).remove().execute()).then(function(){return Promise.cast(i.remoteActions.query("index").lowerBound(e).modify({index:function(e){return e.index-t}}).execute())})}.bind(this))},replaceFileId:function(e){return this._fileInfoPromise.then(function(t){var i=this.getActions(),n=t.id;return t.id=e,this._fileInfoPromise=Promise.cast(t),Promise.all([i,this._fileInfoPromise]).then(function(e){var t=e[0],i=e[1];return this._parent._addFile(i).then(function(e){return this.load(e[0].id)}.bind(this)).then(function(){return this._copyAllActions(t)}.bind(this)).then(function(){return this._parent.deleteFile(n)}.bind(this)).then(function(){return i})}.bind(this))}.bind(this))},close:function(){return this._fileServerPromise.then(function(e){return this._fileServerPromise=Promise.reject(new Error("File Server has been closed")),this._fileInfoPromise=Promise.reject(new Error("File has been closed")),e.close()}.bind(this))},updateLocalModifiedTime:function(e){return this._fileInfoPromise.then(function(t){return t.localModifiedTime=e,this._fileInfoPromise=Promise.resolve(t),this._parent._updateLocalModifiedTime(t.id,e)}.bind(this))},updateDriveModifiedTime:function(e){return this._fileInfoPromise.then(function(t){return t.driveModifiedTime=e,this._fileInfoPromise=Promise.resolve(t),this._parent._updateDriveModifiedTime(t.id,e)}.bind(this))},_copyAllActions:function(e){return this._fileServerPromise.then(function(t){return Promise.all([Promise.cast(t.localActions.add.apply(t,e.local)),Promise.cast(t.remoteActions.add.apply(t,e.remote))]).catch(function(e){console.error("Failed copying actions",e,e.stack,e.message)})})}}),o=e.extend({readyPromise:null,_serverName:null,init:function(e){this._serverName=e?e:"draw",this.readyPromise=Promise.cast(i.open({server:this._serverName,version:2,schema:{files:{key:{keyPath:"id"},indexes:{id:{unique:!0},localModifiedTime:{}}}}}))},fileExists:function(e){return this.readyPromise.then(function(t){return Promise.cast(t.files.query("id").only(e).count().execute()).then(function(e){return 0!==e}.bind(this))}.bind(this))},getFiles:function(){return this.readyPromise.then(function(e){return Promise.cast(e.files.query("localModifiedTime").all().filter(function(e){return!e.deleted}).desc().execute()).then(function(e){return e.map(this._cleanFields)}.bind(this))}.bind(this))},_addFile:function(e){return this.readyPromise.then(function(t){return Promise.cast(t.files.add(e))})},_renameFile:function(e,t){return this.readyPromise.then(function(i){return Promise.cast(i.files.query("id").only(e).modify({name:t}).execute()).then(function(e){return e}.bind(this))}.bind(this))},_updateThumbnail:function(e,t){return this.readyPromise.then(function(i){return Promise.cast(i.files.query("id").only(e).modify({thumbnail:t}).execute()).then(function(e){return e}.bind(this))}.bind(this))},getDeletedFiles:function(){return this.readyPromise.then(function(e){return Promise.cast(e.files.query().filter(function(e){return e.deleted}).execute()).then(function(e){return e.map(this._cleanFields)}.bind(this))}.bind(this))},markFileAsDeleted:function(e){return this.readyPromise.then(function(t){return Promise.cast(t.files.query("id").only(e).modify({deleted:!0}).execute())})},unmarkFileAsDeleted:function(e){return this.readyPromise.then(function(t){return Promise.cast(t.files.query("id").only(e).modify({deleted:!1}).execute()).then(function(e){return n.trigger("fileAdded",e[0]),e})})},deleteFile:function(e){return this.readyPromise.then(function(t){return Promise.cast(t.files.query("id").only(e).remove().execute()).then(function(t){return indexedDB.deleteDatabase(e),t})})},getFileInfo:function(e){return this.readyPromise.then(function(t){return Promise.cast(t.files.query("id").only(e).execute()).then(function(e){return 0==e.length?void 0:e[0]})}).then(function(e){return e&&this._cleanFields(e),e}.bind(this))},_updateLocalModifiedTime:function(e,t){return this.readyPromise.then(function(i){return Promise.cast(i.files.query("id").only(e).modify({localModifiedTime:t}).execute())})},_updateDriveModifiedTime:function(e,t){return this.readyPromise.then(function(i){return Promise.cast(i.files.query("id").only(e).modify({driveModifiedTime:t}).execute())})},clearAll:function(){return Promise.all([this.getFiles(),this.getDeletedFiles()]).then(function(e){return e[0].concat(e[1])}.bind(this)).then(function(e){return e.map(function(e){return this.deleteFile(e.id)}.bind(this)),Promise.all(e).then(function(){indexedDB.deleteDatabase(this._serverName)}.bind(this))}.bind(this))},_cleanFields:function(e){return e.deleted&&delete e.deleted,e},instance:s});return o}),n("dataLayer/webSQLBacking",["class","helpers","event"],function(e,t){var i=e.extend({_parent:null,_fileId:null,init:function(e){this._parent=e},load:function(e){return this._fileId=e,this._parent.getFileInfo(e)},create:function(e){return this._parent._addFile(e).then(function(){return this.load(e.id)}.bind(this))},getActions:function(){return this._parent.readyPromise.then(function(e){return new Promise(function(t,i){e.readTransaction(function(e){var n=[];n.push(new Promise(function(t,i){e.executeSql("SELECT * FROM `F"+this._fileId+"-local`",[],function(e,i){var n=this._parent._convertResultToObject(i,["value"]);t(n)}.bind(this),function(e,t){i(t)})}.bind(this))),n.push(new Promise(function(t,i){e.executeSql("SELECT * FROM `F"+this._fileId+"-remote` ORDER BY `index`",[],function(e,i){var n=this._parent._convertResultToObject(i,["value"]);t(n)}.bind(this),function(e,t){i(t)})}.bind(this))),Promise.all(n).then(function(e){t({local:e[0],remote:e[1]})}).catch(function(e){i(e)})}.bind(this))}.bind(this))}.bind(this))},rename:function(e){return this._parent._renameFile(this._fileId,e)},updateThumbnail:function(e){return this._parent._updateThumbnail(this._fileId,e)},addLocalAction:function(e){return this._parent.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){t.executeSql("INSERT INTO `F"+this._fileId+"-local` (id, type, value) VALUES (?, ?, ?)",[e.id,e.type,JSON.stringify(e.value)],function(e,t){var n=this._parent._convertResultToObject(t,["value"]);i(n[0])}.bind(this),function(e,t){n(t)})}.bind(this))}.bind(this))}.bind(this))},removeLocalAction:function(e){return this._parent.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){t.executeSql("DELETE FROM `F"+this._fileId+"-local` WHERE id = ?",[e],function(e,t){var n=this._parent._convertResultToObject(t,["value"]);i(n[0])}.bind(this),function(e,t){n(t)})}.bind(this))}.bind(this))}.bind(this))},addRemoteActions:function(e,t){return this._parent.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){i.executeSql("UPDATE `F"+this._fileId+"-remote` SET `index` = `index` + ? WHERE `index` >= ?",[t.length,e],function(){var e=[];t.forEach(function(t){e.push(new Promise(function(e,n){i.executeSql("INSERT INTO `F"+this._fileId+"-remote` (id, `index`, type, value) VALUES (?, ?, ?, ?)",[t.id,t.index,t.type,JSON.stringify(t.value)],function(t,i){e(i)},function(e,t){n(t)})}.bind(this)))}.bind(this)),Promise.all(e).then(function(e){n(e)}).catch(function(e){s(e)})}.bind(this),function(e,t){s(t)})}.bind(this))}.bind(this))}.bind(this))},removeRemoteActions:function(e,t){return this._parent.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){i.executeSql("DELETE FROM `F"+this._fileId+"-remote` WHERE `index` between ? and ?",[e,e+t-1],function(){i.executeSql("UPDATE `F"+this._fileId+"-remote` SET `index` = `index` - ? WHERE `index` >= ?",[t,e],function(e,t){n(t)},function(e,t){s(t)})}.bind(this),function(e,t){s(t)})}.bind(this))}.bind(this))}.bind(this))},replaceFileId:function(e){return this._parent._replaceFileId(this._fileId,e).then(function(){this._fileId=e}.bind(this)).catch(function(e){throw console.error("Error replacing fileId",e),e})},close:function(){return this._fileId=null,Promise.resolve()},updateLocalModifiedTime:function(e){return this._parent._updateLocalModifiedTime(this._fileId,e)},updateDriveModifiedTime:function(e){return this._parent._updateDriveModifiedTime(this._fileId,e)}}),n=e.extend({FIELDS:"id, name, localModifiedTime, driveModifiedTime, thumbnail",readyPromise:null,_serverName:null,init:function(e){this._serverName=e?e:"files";var t=openDatabase("draw","","draw",4194304);this.readyPromise=Promise.resolve(t).then(function(e){return new Promise(function(t,i){e.transaction(function(n){n.executeSql("CREATE TABLE IF NOT EXISTS `"+this._serverName+"`"+"("+"id VARCHAR(255) PRIMARY KEY,"+"name VARCHAR(255),"+"localModifiedTime INTEGER,"+"driveModifiedTime VARCHAR(255),"+"thumbnail TEXT,"+"deleted BOOL"+")",[],function(){t(e)},function(e,t){i(t)})}.bind(this))}.bind(this)).then(function(){var t=Promise.resolve();return"1.0"==e.version&&(t=t.then(function(){return new Promise(function(t,i){e.changeVersion(e.version,"2",function(e){e.executeSql("DROP TABLE IF EXISTS `files`",[],function(){t()},function(e,t){i(t)})}.bind(this),function(e){i(e)})}.bind(this)).then(function(){location.reload()})}.bind(this))),t}.bind(this))}.bind(this)).then(function(){return t}).catch(function(e){throw console.error("Error initializing database",e),e})},fileExists:function(e){return this.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){t.executeSql("SELECT COUNT(*) AS count FROM `"+this._serverName+"` WHERE id = ?",[e],function(e,t){i(0!==t.rows.item(0).count)}.bind(this),function(e,t){n(t)})}.bind(this))}.bind(this))}.bind(this))},getFiles:function(){return this.readyPromise.then(function(e){return new Promise(function(t,i){e.readTransaction(function(e){e.executeSql("SELECT "+this.FIELDS+" FROM `"+this._serverName+"` WHERE `deleted`='false' ORDER BY localModifiedTime DESC",[],function(e,i){var n=this._convertResultToObject(i);t(n)}.bind(this),function(e,t){i(t)})}.bind(this))}.bind(this))}.bind(this))},_addFile:function(e){return this.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){var s=[];s.push(new Promise(function(i,n){t.executeSql("INSERT INTO `"+this._serverName+"` VALUES (?, ?, ?, ?, ?, ?)",[e.id,e.name,e.localModifiedTime,e.driveModifiedTime,e.thumbnail,!1],function(e,t){i(t)},function(e,t){n(t)})}.bind(this))),s.push(new Promise(function(i,n){t.executeSql("CREATE TABLE IF NOT EXISTS `F"+e.id+"-local` "+"(id VARCHAR(255) PRIMARY KEY, type VARCHAR(255), value TEXT)",[],function(e,t){i(t)},function(e,t){n(t)})}.bind(this))),s.push(new Promise(function(i,n){t.executeSql("CREATE TABLE IF NOT EXISTS `F"+e.id+"-remote` "+"(id VARCHAR(255) PRIMARY KEY, `index` INTEGER, type VARCHAR(255), value TEXT)",[],function(e,t){i(t)},function(e,t){n(t)})}.bind(this))),Promise.all(s).then(function(){i()}).catch(function(e){n(e)})}.bind(this))}.bind(this))}.bind(this))},_renameFile:function(e,t){return this.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){i.executeSql("UPDATE `"+this._serverName+"` SET name = ? WHERE id = ?",[t,e],function(e,t){var i=this._convertResultToObject(t);n(i[0])}.bind(this),function(e,t){s(t)})}.bind(this))}.bind(this))}.bind(this))},_updateThumbnail:function(e,t){return this.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){i.executeSql("UPDATE `"+this._serverName+"` SET thumbnail = ? WHERE id = ?",[t,e],function(e,t){var i=this._convertResultToObject(t);n(i[0])}.bind(this),function(e,t){s(t)})}.bind(this))}.bind(this))}.bind(this))},_replaceFileId:function(e,t){return this.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){var o=[];o.push(new Promise(function(n,s){i.executeSql("UPDATE `"+this._serverName+"` SET id = ? WHERE id = ?",[t,e],function(e,t){var i=this._convertResultToObject(t);n(i[0])}.bind(this),function(e,t){s(t)})}.bind(this))),o.push(new Promise(function(n,s){i.executeSql("ALTER TABLE `F"+e+"-local` RENAME TO `F"+t+"-local`",[],function(e,t){n(t)},function(e,t){s(t)})})),o.push(new Promise(function(n,s){i.executeSql("ALTER TABLE `F"+e+"-remote` RENAME TO `F"+t+"-remote`",[],function(e,t){n(t)},function(e,t){s(t)})})),Promise.all(o).then(function(e){n(e[0])}).catch(function(e){s(e)})}.bind(this))}.bind(this))}.bind(this))},getDeletedFiles:function(){return this.readyPromise.then(function(e){return new Promise(function(t,i){e.readTransaction(function(e){e.executeSql("SELECT "+this.FIELDS+" FROM `"+this._serverName+"` WHERE `deleted`='true' ORDER BY localModifiedTime DESC",[],function(e,i){var n=this._convertResultToObject(i);t(n)}.bind(this),function(e,t){i(t)})}.bind(this))}.bind(this))}.bind(this))},markFileAsDeleted:function(e){return this.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){t.executeSql("UPDATE `"+this._serverName+"` SET deleted = ? WHERE id = ?",[!0,e],function(e,t){var n=this._convertResultToObject(t);i(n[0])}.bind(this),function(e,t){n(t)})}.bind(this))}.bind(this))}.bind(this))},unmarkFileAsDeleted:function(e){return this.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){t.executeSql("UPDATE `"+this._serverName+"` SET deleted = ? WHERE id = ?",[!1,e],function(e,t){var n=this._convertResultToObject(t);i(n[0])}.bind(this),function(e,t){n(t)})}.bind(this))}.bind(this))}.bind(this))},deleteFile:function(e){return this.readyPromise.then(function(t){return new Promise(function(i,n){t.transaction(function(t){var s=[];s.push(new Promise(function(i,n){t.executeSql("DELETE FROM `"+this._serverName+"` WHERE id = ?",[e],function(e,t){var n=this._convertResultToObject(t);i(n[0])}.bind(this),function(e,t){n(t)})}.bind(this))),s.push(new Promise(function(i,n){t.executeSql("DROP TABLE IF EXISTS `F"+e+"-local`",[],function(){i()}.bind(this),function(e,t){n(t)})})),s.push(new Promise(function(i,n){t.executeSql("DROP TABLE IF EXISTS `F"+e+"-remote`",[],function(){i()}.bind(this),function(e,t){n(t)})})),Promise.all(s).then(function(e){i(e[0])}).catch(function(e){n(e)})}.bind(this))}.bind(this))}.bind(this))},getFileInfo:function(e){return this.readyPromise.then(function(t){return new Promise(function(i,n){t.readTransaction(function(t){t.executeSql("SELECT "+this.FIELDS+" FROM `"+this._serverName+"` WHERE id = ?",[e],function(e,t){var n=this._convertResultToObject(t);i(n[0])}.bind(this),function(e,t){n(t)})}.bind(this))}.bind(this))}.bind(this))},_updateLocalModifiedTime:function(e,t){return this.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){i.executeSql("UPDATE `"+this._serverName+"` SET localModifiedTime = ? WHERE id = ?",[t,e],function(e,t){var i=this._convertResultToObject(t);n(i[0])}.bind(this),function(e,t){s(t)})}.bind(this))}.bind(this))}.bind(this))},_updateDriveModifiedTime:function(e,t){return this.readyPromise.then(function(i){return new Promise(function(n,s){i.transaction(function(i){i.executeSql("UPDATE `"+this._serverName+"` SET driveModifiedTime = ? WHERE id = ?",[t,e],function(e,t){var i=this._convertResultToObject(t);n(i[0])}.bind(this),function(e,t){s(t)})}.bind(this))}.bind(this))}.bind(this))},_convertResultToObject:function(e,i){for(var n=e.rows,s=new Array(n.length),o=0;o<n.length;o++){var r=n.item(o);if(s[o]=t.clone(r),i)for(var a=0;a<i.length;a++){var c=s[o][i[a]];if(c){var l=JSON.parse(c);s[o][i[a]]=l}}}return s},clearAll:function(){return Promise.all([this.getFiles(),this.getDeletedFiles()]).then(function(e){return e[0].concat(e[1])}.bind(this)).then(function(e){return e.map(function(e){return this.deleteFile(e.id)}.bind(this)),Promise.all(e).then(function(){return this.readyPromise
}.bind(this)).then(function(e){return new Promise(function(t,i){e.transaction(function(e){e.executeSql("DROP TABLE `"+this._serverName+"`",[],function(){t()}.bind(this),function(e,t){i(t)})}.bind(this))}.bind(this))}.bind(this))}.bind(this))},instance:i});return n}),n("dataLayer/driveBacking",["class","helpers","gauth"],function(e,t,i){var n=e.extend({_parent:null,_docPromise:null,_addedCallback:null,_removedCallback:null,_updateFileTimeout:null,init:function(e){this._parent=e,this._actionsAdded=this._actionsAdded.bind(this),this._actionsRemoved=this._actionsRemoved.bind(this),this._saveStateChanged=this._saveStateChanged.bind(this)},listen:function(e,t){this._addedCallback=e,this._removedCallback=t},stopListening:function(){this._addedCallback=null,this._removedCallback=null},load:function(e){return this._parent._open(e).then(function(e){return this._openForRealtime(e.id)}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},create:function(e){return this._parent._add(e).then(function(e){return this._openForRealtime(e.id).then(function(){return e})}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},_openForRealtime:function(e){return new Promise(function(t,n){gapi.drive.realtime.load(e,function(e){this._docPromise=Promise.resolve(e),this._docPromise.then(function(e){var i=e.getModel().getRoot().get("actions");i.addEventListener(gapi.drive.realtime.EventType.VALUES_ADDED,this._actionsAdded),i.addEventListener(gapi.drive.realtime.EventType.VALUES_REMOVED,this._actionsRemoved),e.addEventListener(gapi.drive.realtime.EventType.DOCUMENT_SAVE_STATE_CHANGED,this._saveStateChanged),t(this._docPromise)}.bind(this))}.bind(this),function(t){var i=t.createList(),n=t.getRoot();n.set("title","Untitled File"),n.set("actions",i),n.set("id",e)},function(e){if(e.type==gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED)return console.warn("Token expired, reauthorizing"),i.authorize(),void 0;e.type==gapi.drive.realtime.ErrorType.CLIENT_ERROR||e.type==gapi.drive.realtime.ErrorType.NOT_FOUND;var e=new Error;e.object=e,n(e)})}.bind(this))},_actionsAdded:function(e){this._addedCallback&&this._addedCallback(e)},_actionsRemoved:function(e){this._removedCallback&&this._removedCallback(e)},_saveStateChanged:function(){this._updateFileTimeout&&clearTimeout(this._updateFileTimeout),this._updateFileTimeout=setTimeout(function(){this._docPromise.then(function(e){this._parent.touchFile(e.getModel().getRoot().get("id")).then(function(e){console.log("Touched file",e)}).catch(function(e){console.error("Error touching file",e)})}.bind(this))}.bind(this),2e3)},getActions:function(){return this._docPromise.then(function(e){return e.getModel().getRoot().get("actions").asArray()})},rename:function(e){return this._docPromise.then(function(t){return t.getModel().getRoot().set("title",e),this._parent._renameFile(t.getModel().getRoot().get("id"),e)}.bind(this))},addAction:function(e){return this._docPromise.then(function(t){var i=t.getModel().getRoot().get("actions");i.insert(i.length,e)})},removeAction:function(e){return this._docPromise.then(function(t){var i=t.getModel().getRoot().get("actions");i.remove(e)})},undo:function(){return this._docPromise.then(function(e){e.getModel().undo()})},redo:function(){return this._docPromise.then(function(e){e.getModel().redo()})},close:function(){return!this._docPromise,this._docPromise.then(function(e){e.close()})}}),s=e.extend({_appId:450627732299,_key:"AIzaSyAOU0dwrVt0XNvGibqE93ATS2X1bMP5pAI",REALTIME_MIMETYPE:"application/vnd.google-apps.drive-sdk",APP_MIMETYPE:null,_fields:"id,modifiedDate,shared,title,userPermission(role)",init:function(){this.APP_MIMETYPE=this.REALTIME_MIMETYPE+"."+this._appId},getFiles:function(){return new Promise(function(e,t){gapi.client.load("drive","v2",function(){gapi.client.drive.files.list({q:"trashed=false and mimeType='"+this.APP_MIMETYPE+"'",fields:"items("+this._fields+")"}).execute(function(i){if(!i)return e([]),void 0;if(i.error){var n=new Error;n.object=i,t(n)}else e(i.items)})}.bind(this))}.bind(this))},getFileInfo:function(e){return new Promise(function(t,i){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:e,fields:this._fields+",owners(displayName,picture)",key:this._key}).execute(function(e){if(e.error){var n=new Error;n.object=e,i(n)}else t(e)}.bind(this))}.bind(this))}.bind(this))},canReadFile:function(e){return new Promise(function(t){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:e,fields:"mimeType",key:this._key}).execute(function(e){e.error?t(!1):e.mimeType==this.APP_MIMETYPE?t(!0):t(!1)}.bind(this))}.bind(this))}.bind(this))},_open:function(e){return new Promise(function(t,i){gapi.client.load("drive","v2",function(){gapi.client.drive.files.get({fileId:e,fields:this._fields}).execute(function(e){if(e.error){var n=new Error;n.object=e,i(n)}else t({id:e.id})}.bind(this))}.bind(this))}.bind(this))},_add:function(e){return new Promise(function(t,i){gapi.client.load("drive","v2",function(){gapi.client.drive.files.insert({resource:{mimeType:this.REALTIME_MIMETYPE,title:e.name},fields:this._fields}).execute(function(e){if(e.error){var n=new Error;n.object=e,i(n)}else t({id:e.id})})}.bind(this))}.bind(this))},_renameFile:function(e,t){return new Promise(function(i,n){var s={title:t};gapi.client.load("drive","v2",function(){var t=gapi.client.drive.files.patch({fileId:e,resource:s,fields:this._fields});t.execute(function(e){if(e.error){var t=new Error;t.object=e,n(t)}else i(e)})}.bind(this))}.bind(this))},deleteFile:function(e){return new Promise(function(t,i){gapi.client.load("drive","v2",function(){gapi.client.drive.files.trash({fileId:e,fields:this._fields}).execute(function(e){if(e.error){var n=new Error;n.object=e,i(n)}else t(e)})}.bind(this))}.bind(this))},touchFile:function(e){return new Promise(function(t,i){gapi.client.load("drive","v2",function(){gapi.client.drive.files.touch({fileId:e,fields:this._fields}).execute(function(e){if(e.error){var n=new Error;n.object=e,i(n)}else t(e)})}.bind(this))}.bind(this))},instance:n});return s}),n("data",["dataLayer/data","event","dataLayer/indexedDBBacking","dataLayer/webSQLBacking","dataLayer/driveBacking"],function(e,t,i,n,s){var o;o=window.indexedDB?new i:new n;var r=new s,a=new e(o,r);return t.addListener("authenticatedStatusChanged",function(e){e.authenticated&&(console.log("Syncing open files"),a.syncOpenFiles())}),a}),n("migrate",["data"],function(){var e=function(){this.init()};return e.prototype={init:function(){},run:function(){var e=localStorage.dataVersion,t=Promise.resolve();return e||(t=t.then(function(){}.bind(this)).then(function(){})),t}},new e}),n("section",["class"],function(e){var t=e.extend({id:null,element:null,_visible:null,init:function(){this.id&&(this.element=document.getElementById(this.id)),this._visible=!1},setElement:function(e){this.element=e},show:null,hide:null,afterShow:function(){this.element.style.display="block",this._visible=!0},afterHide:function(){this.element.style.display="",this._visible=!1}});return t}),n("tapHandler",[],function(){function e(e,t){this.init(e,t)}return e.prototype={_element:null,_options:null,_distCutoff:20,_timeCutoff:500,_startType:null,_startTouchId:null,_startTime:null,_startX:null,_startY:null,_lastX:null,_lastY:null,_offset:null,_inGesture:!1,_ignoreGestures:!1,init:function(e,t){this._element=e,this._options=t,this._mouseDown=this._mouseDown.bind(this),this._touchDown=this._touchDown.bind(this),this._mouseMove=this._mouseMove.bind(this),this._touchMove=this._touchMove.bind(this),this._mouseUp=this._mouseUp.bind(this),this._touchUp=this._touchUp.bind(this),this._down=this._down.bind(this),this._move=this._move.bind(this),this._end=this._end.bind(this),this._gestureStart=this._gestureStart.bind(this),this._gestureChange=this._gestureChange.bind(this),this._gestureEnd=this._gestureEnd.bind(this),this._offset={x:e.offsetLeft,y:e.offsetTop},this._element.addEventListener("mousedown",this._mouseDown),this._element.addEventListener("touchstart",this._touchDown)},ignoreGestures:function(e){this._ignoreGestures=e},_calculateMouseXY:function(e){e.x=e.clientX,e.y=e.clientY},_calculateTouchXY:function(e){var t=this._indexOfTouch(e,this._startTouchId);e.x=e.touches[t].clientX,e.y=e.touches[t].clientY},_calculateGestureXY:function(e){e.x=(e.touches[0].clientX+e.touches[1].clientX)/2,e.y=(e.touches[0].clientY+e.touches[1].clientY)/2},_mouseDown:function(e){this._startType="mouse",this._calculateMouseXY(e),this._down(e),document.addEventListener("mousemove",this._mouseMove),document.addEventListener("mouseup",this._mouseUp)},_touchDown:function(e){this._startType="touch",null===this._startTouchId&&(this._startTouchId=e.touches[e.touches.length-1].identifier),e.touches.length>=2&&!this._ignoreGestures?this._gestureStart(e):(this._calculateTouchXY(e),this._down(e)),document.addEventListener("touchmove",this._touchMove),document.addEventListener("touchend",this._touchUp)},_down:function(e){this._processEvent(e),this._startTime=Date.now(),this._startX=this._lastX=e.x,this._startY=this._lastY=e.y,this._options.start&&this._options.start(e)},_gestureStart:function(e){this._inGesture=!0,this._options.end&&(this._options.end(e),this._startTouchId=null),this._calculateGestureXY(e),this._startTime=Date.now(),this._startX=this._lastX=e.x,this._startY=this._lastY=e.y,this._startDistance=this._getGestureDistance(e),this._lastScale=1,this._options.gestureStart&&this._options.gestureStart(e)},_mouseMove:function(e){this._calculateMouseXY(e),this._move(e)},_touchMove:function(e){this._inGesture?this._gestureChange(e):(this._calculateTouchXY(e),this._move(e))},_move:function(e){this._processEvent(e),this._lastX=e.x,this._lastY=e.y,this._options.move&&this._options.move(e)},_gestureChange:function(e){this._calculateGestureXY(e),this._processEvent(e);var t=this._getGestureDistance(e);e.scale=t/this._startDistance,e.scaleFromLast=e.scale-this._lastScale,this._lastX=e.x,this._lastY=e.y,this._lastScale=e.scale,this._options.gesture&&this._options.gesture(e)},_mouseUp:function(e){document.removeEventListener("mousemove",this._mouseMove),document.removeEventListener("mouseup",this._mouseUp),this._end(e)},_touchUp:function(e){return this._inGesture?(this._gestureEnd(e),void 0):(this._containsTouch(e,this._startTouchId)||(document.removeEventListener("touchmove",this._touchMove),document.removeEventListener("touchend",this._touchUp),this._end(e),this._startTouchId=null),void 0)},_end:function(e){this._processEvent(e),e.wasTap=!1;var t=Math.sqrt((this._lastX-this._startX)*(this._lastX-this._startX)+(this._lastY-this._startY)*(this._lastY-this._startY));t<this._distCutoff&&Date.now()-this._startTime<this._timeCutoff&&(e.wasTap=!0,this._options.tap&&this._options.tap(e)),this._options.end&&this._options.end(e),this._startX=null,this._startY=null,e.preventDefault(),e.stopImmediatePropagation()},_gestureEnd:function(e){e.touches.length>=2||(this._inGesture=!1,this._options.gestureEnd&&this._options.gestureEnd(e),document.removeEventListener("touchmove",this._touchMove),document.removeEventListener("touchend",this._touchUp))},_processEvent:function(e){e.distFromLeft=e.x-this._offset.x,e.distFromTop=e.y-this._offset.y,e.xFromLast=e.x-this._lastX,e.yFromLast=e.y-this._lastY,e.distFromStartX=null!==this._startX?e.x-this._startX:0,e.distFromStartY=null!==this._startY?e.y-this._startY:0},_getGestureDistance:function(e){var t=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY,n=Math.sqrt(t*t+i*i);return n},_containsTouch:function(e){return-1!==this._indexOfTouch(e,this._startTouchId)},_indexOfTouch:function(e,t){var i=-1;if(e.touches&&null!==t)for(var n=0;n<e.touches.length;n++)if(e.touches[n].identifier==t){i=n;break}return i},clear:function(){this._element.removeEventListener("mousedown",this._mouseDown),this._element.removeEventListener("touchstart",this._touchDown),document.removeEventListener("mousemove",this._mouseMove),document.removeEventListener("mouseup",this._mouseUp),document.removeEventListener("touchmove",this._touchMove),document.removeEventListener("touchend",this._touchUp)}},e}),n("sections/login",["event","section","tapHandler","online","gauth","data"],function(e,t,i,n,s,o){var r=t.extend({id:"login",_basicBox:null,_fileBox:null,_fileTitleElement:null,_userProfileElement:null,_fileOwnersElement:null,_button:null,init:function(){this._super(),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),this._basicBox=document.getElementById("login-basic"),this._fileBox=document.getElementById("login-file"),this._fileTitleElement=document.getElementById("login-file-title"),this._userProfileElement=document.getElementById("login-owner-pic"),this._fileOwnersElement=document.getElementById("login-file-owners"),this._button=document.getElementById("loginbutton"),new i(this._button,{tap:this._loginClicked.bind(this)})},show:function(){n.isOnline()&&(console.log("already online"),this._turnOnline()),e.addListener("onlineStatusChanged",this._onlineStatusChanged)},hide:function(){e.removeListener("onlineStatusChanged",this._onlineStatusChanged)},_onlineStatusChanged:function(){this._turnOnline()},displayFileInfo:function(e){this._basicBox.classList.add("hidden"),this._waitAnimationEnd().then(function(){var t=e.owners[0];this._fileTitleElement.textContent=e.title,this._fileOwnersElement.textContent=t.displayName,this._userProfileElement.src=t.picture.url,this._fileBox.classList.remove("hidden")}.bind(this))},_turnOnline:function(){this._button.classList.remove("disabled");var e=location.hash;0===e.indexOf("#")&&(e=e.slice(1),o.getRemoteFileInfo(e).then(function(e){this.displayFileInfo(e)}.bind(this)))},_waitAnimationEnd:function(){return new Promise(function(e){setTimeout(function(){e()},500)}.bind(this))},_loginClicked:function(){n.isOnline()&&s.authorizeWithPopup()}});return r}),n("platform",["class"],function(e){var t=e.extend({_b:null,standalone:null,transition:null,transitionEnd:null,animation:null,transform:null,transformOrigin:null,mouseWheel:null,init:function(){this._b=document.body,this.standalone=!!window.navigator.standalone,this.transition=this.addPrefix("transition"),this.transitionEnd={transition:"transitionend",webkitTransition:"webkitTransitionEnd",MozTransition:"transitionEnd",OTransition:"oTransitionEnd"}[this.transition],this.animation=this.addPrefix("animation"),this.transform=this.addPrefix("transform"),this.transformOrigin=this.addPrefix("transformOrigin"),this.mouseWheel="undefined"!=typeof window.onwheel?"wheel":"mousewheel",window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB||window.oIndexedDB},addPrefix:function(e){var t="",i=["ms","webkit","mox","o"],n=this._b.style;if("string"==typeof n[e])t="";else for(var s=0;s<i.length;s++)if("string"==typeof n["-"+i[s]+"-"+e]){t=i[s];break}var o=t.length>0?e.charAt(0).toUpperCase()+e.slice(1):e;return t?t+o:o}}),i=new t;return i}),n("sections/statusIndicator",["event","section","online","platform"],function(e,t,i){var n=t.extend({id:"mode",init:function(){this._super(),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),e.addListener("onlineStatusChanged",this._onlineStatusChanged),i.isOnline()||i.waitToComeOnline(1500).catch(function(){this._showOffline()}.bind(this))},_onlineStatusChanged:function(e){e.online?this._showOnline():this._showOffline()},_showOnline:function(){this.element.classList.add("hidden"),this._waitAnimationEnd().then(function(){this.element.textContent="Online",this.element.classList.remove("hidden"),this.element.classList.remove("offline")}.bind(this))},_showOffline:function(){this.element.classList.add("hidden"),this._waitAnimationEnd().then(function(){this.element.textContent="Offline",this.element.classList.remove("hidden"),this.element.classList.add("offline")}.bind(this))},_waitAnimationEnd:function(){return new Promise(function(e){setTimeout(function(){e()},500)}.bind(this))}});return n}),n("template",[],function(){function e(e){var t=document.getElementById("template-"+e),i=document.createElement("div");return i.innerHTML=t.innerHTML,i.children[0]}return e}),n("sections/fileItem",["section","tapHandler","event","globals","helpers","platform","template","online","gauth","data"],function(e,t,i,n,s,o,r,a,c,l){var u=e.extend({_fileList:null,_thumbnailInfoElement:null,_fileNameElement:null,_thumbnailElement:null,_fileInfo:null,_slideMax:null,_slideState:null,init:function(e,i){this._super(),this._fileList=e,this._fileInfo=i;var s=new r("fileListItem");if(this.setElement(s),this._thumbnailInfoElement=s.getElementsByClassName("thumbnail-info")[0],this._fileNameElement=s.getElementsByClassName("file-name")[0],this._thumbnailElement=s.getElementsByClassName("thumbnail")[0],this._fileNameElement.textContent=i.name,this._thumbnailElement.src=i.thumbnail,new t(this.element,{tap:this._docTapped.bind(this),start:this._docStarted.bind(this),move:this._docMoved.bind(this),end:this._docEnded.bind(this)}),n.isMobile()){this._thumbnailElement.style[o.transform]="translateX(0px);",this._thumbnailElement.translateX=0;var a=s.getElementsByClassName("delete")[0];window.a=a}},_docTapped:function(e){var t=e.target,i=s.parentEleWithClassname(t,"file-action");if(i){var n=i.dataset.action;if("delete"==n)return l.deleteFile(this._fileInfo.id)}else s.parentEleIsElement(t,this._thumbnailInfoElement)&&this._fileList.drawFile(this._fileInfo)},_docStarted:function(){if(n.isMobile()){this._slideState=null;var e=this._thumbnailInfoElement.getElementsByClassName("delete")[0];this._slideMax=-1*e.offsetWidth}},_docMoved:function(e){if(n.isMobile()){if(e.target!=this._thumbnailElement)return;var t=Math.sqrt(e.distFromStartX*e.distFromStartX+e.distFromStartY+e.distFromStartY);if(3>t?e.preventDefault():null===this._slideState&&(this._slideState=Math.abs(e.distFromStartX)>Math.abs(e.distFromStartY)?"sliding":"scrolling"),"sliding"==this._slideState){var i=this._thumbnailElement.translateX+e.xFromLast,s=Math.max(this._slideMax,Math.min(i,0));this._thumbnailElement.style[o.transform]="translateX("+s+"px)",this._thumbnailElement.translateX=s,e.preventDefault()}}},_docEnded:function(){n.isMobile()&&(this._slideState=null,this._thumbnailElement.classList.add("animating"),this._thumbnailElement.translateX<this._slideMax/3?(this._thumbnailElement.style[o.transform]="translateX("+this._slideMax+"px)",this._thumbnailElement.translateX=this._slideMax):(this._thumbnailElement.style[o.transform]="translateX(0px)",this._thumbnailElement.translateX=0),window.setTimeout(function(){this._thumbnailElement.classList.remove("animating")}.bind(this),300))},updateFileName:function(e){this._fileNameElement.textContent=e},updateThumbnail:function(e){this._thumbnailElement.src=e}});return u}),n("sections/fileList",["section","tapHandler","event","globals","helpers","online","gauth","sections/statusIndicator","sections/fileItem","data"],function(e,t,i,n,s,o,r,a,c,l){var u=e.extend({id:"files-list-container",_filesPane:null,_fileListElement:null,_files:null,_updateTimeout:null,_indicator:null,_itemWidth:null,init:function(e){this._super(),this._filesPane=e,this._files=[],this._indicator=new a,this._fileListElement=document.getElementById("files-list"),this._scheduleUpdate=this._scheduleUpdate.bind(this),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),this._authenticatedStatusChanged=this._authenticatedStatusChanged.bind(this),l.getFiles().then(function(e){for(var t=0;t<e.length;t++){var i=e[t],n=this._newFileWrapper(i);this._fileListElement.appendChild(n)}}.bind(this)),this.element.addEventListener("wheel",function(e){e.stopPropagation()}),new t(document.getElementById("create-file"),{tap:this._createTapped.bind(this)}),i.addListener("fileAdded",this._fileAdded.bind(this)),i.addListener("fileRemoved",this._fileRemoved.bind(this)),i.addListener("fileModified",this._fileModified.bind(this)),i.addListener("fileRenamed",this._fileRenamed.bind(this)),i.addListener("fileIdChanged",this._fileIdChanged.bind(this)),i.addListener("fileModifiedRemotely",this._fileModifiedRemotely.bind(this)),i.addListener("thumbnailUpdated",this._thumbnailUpdated.bind(this))},_newFileWrapper:function(e){var t=new c(this,e);return t.element.fileInfo=e,this._files.push({fileInfo:e,fileItem:t,element:t.element}),t.element},show:function(){console.log("Showing file list"),i.addListener("onlineStatusChanged",this._onlineStatusChanged),i.addListener("authenticatedStatusChanged",this._authenticatedStatusChanged),o.isOnline()&&l.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this))},hide:function(){console.log("hiding file list"),i.removeListener("onlineStatusChanged",this._onlineStatusChanged),i.removeListener("authenticatedStatusChanged",this._authenticatedStatusChanged),this._updateTimeout&&clearTimeout(this._updateTimeout)},_scheduleUpdate:function(){this._updateTimeout&&clearTimeout(this._updateTimeout),this._updateTimeout=setTimeout(function(){this._visible&&o.isOnline()&&l.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this))}.bind(this),15e3)},drawFile:function(e){this._filesPane.setPane("draw",e)},_createTapped:function(){return l.createFile().then(function(e){return e.fileInfoPromise}).then(function(e){console.log("Showing draw for",e),this._filesPane.setPane("draw",e)}.bind(this))},_onlineStatusChanged:function(e){e.online&&r.isAuthenticated()&&l.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},_authenticatedStatusChanged:function(e){e.authenticated&&l.checkForUpdates().then(function(){this._scheduleUpdate()}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},_fileAdded:function(e){var t=this._newFileWrapper(e);this._fileListElement.insertBefore(t,this._fileListElement.children[1])},_fileRemoved:function(e){for(var t in this._files){var i=this._files[t];if(i.fileInfo.id==e)return this._fileListElement.removeChild(i.element),delete this._files[t],void 0}},_fileModified:function(e){for(var t in this._files){var i=this._files[t];if(i.fileInfo.id==e.id)return i.fileInfo.modifiedTime=e.modifiedTime,this._fileListElement.removeChild(i.element),this._fileListElement.insertBefore(i.element,this._fileListElement.children[1]),void 0}},_fileRenamed:function(e){for(var t in this._files){var i=this._files[t];if(i.fileInfo.id==e.id)return i.fileItem.updateFileName(e.name),i.fileInfo.name=e.name,void 0}},_fileIdChanged:function(e){for(var t in this._files){var i=this._files[t];if(i.fileInfo.id==e.oldId){i.fileInfo.id=e.newId;break}}},_fileModifiedRemotely:function(){},_thumbnailUpdated:function(e){for(var t in this._files){var i=this._files[t];if(i.fileInfo.id==e.id)return i.fileItem.updateThumbnail(e.thumbnail),i.fileInfo.thumbnail=e.thumbnail,void 0}}});return u}),n("sections/draw",["section","globals","event","helpers","tapHandler","platform","db","bezierCurve","data","online","components/manipulateCanvas"],function(e,t,i,n,s,o,r,a,c,l,u){var h=e.extend({id:"draw",_filesPane:null,_manipulateCanvas:null,_canvas:null,_file:null,_settings:null,_currentAction:null,_update:!1,_updateAll:!0,_updateCurrentAction:!1,_shouldRender:!1,_saveSettingsTimeout:null,_mouseWheelTimeout:null,_fileSyncTimeout:null,_canvasTapHandler:null,_toolTapHandler:null,_fileNameElement:null,_overlay:null,init:function(e){this._super(),this._filesPane=e,this._canvas=document.getElementById("canvas"),this._actionsAdded=this._actionsAdded.bind(this),this._actionsRemoved=this._actionsRemoved.bind(this),this._resize=this._resize.bind(this),this._fileModifiedRemotely=this._fileModifiedRemotely.bind(this),this._fileRenamed=this._fileRenamed.bind(this),this._redraw=this._redraw.bind(this),this._onlineStatusChanged=this._onlineStatusChanged.bind(this),this._scheduleMouseWheelTimeout=this._scheduleMouseWheelTimeout.bind(this),this.element.addEventListener("touchmove",function(e){e.preventDefault()}),this._canvasTapHandler=new s(this.element,{start:this._start.bind(this),move:this._move.bind(this),end:this._end.bind(this),gesture:this._gesture.bind(this),gestureStart:this._gestureStart.bind(this),gestureEnd:this._gestureEnd.bind(this)}),this._toolTapHandler=new s(document.getElementById("tools"),{tap:this._toolChanged.bind(this),start:this._toolStart.bind(this),end:this._toolEnd.bind(this)}),new s(document.getElementById("menu"),{start:function(e){e.stopPropagation()},tap:this._menuTapped.bind(this)}),new s(document.getElementById("fileName"),{start:function(e){e.stopPropagation()}}),new s(document.getElementById("colorPicker"),{start:function(e){e.stopPropagation()},tap:this._colorPicked.bind(this)}),this._overlay=document.getElementById("draw-overlay"),this._overlay.addEventListener("mousedown",this._hideModal.bind(this)),this._overlay.addEventListener("touchstart",this._hideModal.bind(this)),this.element.addEventListener(o.mouseWheel,this._mouseWheel.bind(this)),this.element.addEventListener("keydown",this._keyDown.bind(this)),this._fileNameElement=document.getElementById("fileName"),this._fileNameElement.addEventListener("keydown",this._fileNameKeyDown.bind(this)),this._fileNameElement.addEventListener("blur",this._fileNameBlur.bind(this))},show:function(e){return this._tryLoadFile(e).catch(function(){return l.waitToComeOnline(1e4).then(function(){return c.loadFileFromRemote(e.id)}.bind(this)).then(function(e){return this._tryLoadFile(e)}.bind(this)).catch(function(e){console.error("Unable to draw for this file",e),location.hash="",this._filesPane.setPane("list")}.bind(this))}.bind(this))},_tryLoadFile:function(e){return c.loadFile(e.id).then(function(e){this._file=e,e.listen(this._actionsAdded,this._actionsRemoved),e.fileInfoPromise.then(function(e){this._fileNameElement.value=e.name}.bind(this)),e.localSettings().then(function(e){this._settings=e,document.getElementById("chosenColorSwatch").style.backgroundColor=this._settings.color,this._setActiveTool(),this._manipulateCanvas=new u(this._canvas,this._settings),this._redraw(),this._scheduleUpdate()}.bind(this)),this._updateAll=!0,this._shouldRender=!0,i.addListener("fileModifiedRemotely",this._fileModifiedRemotely),i.addListener("fileRenamed",this._fileRenamed),i.addListener("onlineStatusChanged",this._onlineStatusChanged),this._resize(),setTimeout(function(){this._canvas.focus()}.bind(this),400),window.addEventListener("resize",this._resize)}.bind(this))},hide:function(){this._file&&(this._file.stopListening(),window.setTimeout(function(){this._file.updateThumbnail().then(function(e){return c.close(e)}.bind(this,this._file)).catch(function(e){console.error(e,e.stack,e.message)})}.bind(this),600)),this._shouldRender=!1,i.removeListener("fileModifiedRemotely",this._fileModifiedRemotely),i.removeListener("fileRenamed",this._fileRenamed),i.removeListener("onlineStatusChanged",this._onlineStatusChanged),window.removeEventListener("resize",this._resize)},_actionsAdded:function(e){e.isLocal?(this._update=!0,this._manipulateCanvas.addAction(e.items[0])):this._updateAll=!0},_actionsRemoved:function(){this._updateAll=!0},_resize:function(){this._canvas.width=window.innerWidth,this._canvas.height=window.innerHeight,this._updateAll=!0},_zoom:function(e,t,i){this._manipulateCanvas.zoom(e,t,i)&&(this._saveSettings(),this._updateAll=!0)},_pan:function(e,t){this._manipulateCanvas.pan(e,t)&&(this._saveSettings(),this._updateAll=!0)},_mouseWheel:function(e){var t=isNaN(e.deltaX)?e.wheelDeltaX/5:-e.deltaX,i=isNaN(e.deltaY)?e.wheelDeltaY/5:-e.deltaY;this._manipulateCanvas.useCurves(!1),this._scheduleMouseWheelTimeout(),"pan"==this._settings.tools.scroll?this._pan(t,i):"zoom"==this._settings.tools.scroll&&0!=i&&this._zoom(e.clientX,e.clientY,i/100*this._settings.scale)},_scheduleMouseWheelTimeout:function(){this._mouseWheelTimeout&&clearTimeout(this._mouseWheelTimeout),this._mouseWheelTimeout=setTimeout(function(){this._manipulateCanvas.useCurves(!0),this._updateAll=!0}.bind(this),100)},_start:function(e){var t=this._settings.tools.gesture||this._settings.tools.point;if(1==e.button&&(t="pan"),"pan"==t)return this._manipulateCanvas.useCurves(!1),void 0;var i=n.screenToWorld(this._settings,e.distFromLeft,e.distFromTop);this._currentAction&&console.error("Current action isn't null!"),this._currentAction={type:"stroke",value:{points:[[i.x,i.y]],width:2,lockWidth:!0,color:this._settings.color}},"eraser"==t?(this._currentAction.value.width=30/this._settings.scale,this._currentAction.value.color="#ffffff",this._currentAction.value.lockWidth=!1):"pencil"==this._settings.tools.point},_move:function(e){var t=this._settings.tools.gesture||this._settings.tools.point;if(1==e.button&&(t="pan"),"pan"==t)this._pan(e.xFromLast,e.yFromLast);else if("pencil"==t||"eraser"==t){if(!this._currentAction)return;var i=n.screenToWorld(this._settings,e.distFromLeft,e.distFromTop),s=this._currentAction.value,o=s.points,r=o[o.length-1],a=Math.sqrt((r[0]-i[0])*(r[0]-i[0])+(r[1]-i[1])*(r[1]-i[1]));if(.001>a)return;s.points.push([i.x,i.y]),this._updateCurrentAction=!0}},_end:function(){var e=this._settings.tools.gesture||this._settings.tools.point;if("pan"==e)this._manipulateCanvas.useCurves(!0),this._updateAll=!0;else if("pencil"==e||"eraser"==e){if(!this._currentAction)return;var t=this._currentAction;this._currentAction=null;var i=t.value;if(i.points.length<2)return;var s=n.cloneArray(a.getCurveControlPoints(i.points));i.controlPoints=s,this._updateCurrentAction=!0,this._updateAll=!0,this._saveAction(t)}},_saveAction:function(e){e.id=n.getGuid(),this._file.addAction(e).catch(function(e){console.error(e,e.stack,e.message)})},_gesture:function(e){this._pan(e.xFromLast,e.yFromLast),this._zoom(e.x,e.y,e.scaleFromLast*this._settings.scale)},_gestureStart:function(){this._manipulateCanvas.useCurves(!1)},_gestureEnd:function(){this._manipulateCanvas.useCurves(!0),this._updateAll=!0},_redraw:function(){if(this._shouldRender){if(this._updateAll){var e=this._file.getActions();this._manipulateCanvas.doAll(e)}if(this._updateCurrentAction&&this._currentAction){var t=this._currentAction,i=a.getCurveControlPoints(t.value.points);t.value.controlPoints=i,this._manipulateCanvas.doTemporaryAction(t)}(this._updateAll||this._updateCurrentAction||this._update)&&(this._manipulateCanvas.render(),this._update=!1,this._updateAll=!1,this._updateCurrentAction=!1),requestAnimationFrame(this._redraw)}},_menuTapped:function(e){if("LI"==e.target.tagName){var t=e.target.dataset.action;"back"==t?this._file.fileInfoPromise.then(function(e){this._filesPane.setPane("list",e)}.bind(this)):"rename"==t&&e.target.focus()}},_showModal:function(e){var t=document.getElementById(e);return t?(this._overlay.currentModal=e,this._overlay.style.visibility="visible",setTimeout(function(){t.classList.add("visible")},0),void 0):(console.error("No modal with that id"),void 0)},_hideModal:function(e){if(!e||e.target==this._overlay){if(this._overlay.currentModal){var t=document.getElementById(this._overlay.currentModal);if(t.dataset.closeable&&"false"===t.dataset.closeable)return e&&e.stopPropagation(),void 0;t.classList.remove("visible"),this._overlay.currentModal=""}this._overlay.style.visibility="hidden"}},_colorPicked:function(e){var t=n.parentEleWithClassname(e.target,"swatch");if(t){var i=t.style.backgroundColor;this._settings.color=i,this._saveSettings(),document.getElementById("chosenColorSwatch").style.backgroundColor=i,this._hideModal()}e.stopPropagation()},_toolStart:function(e){var t=e.target.dataset.tool;e.target.dataset.action,"LI"==e.target.tagName&&t&&("pan"==t||"eraser"==t||"pencil"==t)&&(this._settings.tools.gesture=t,this._setActiveTool(),this._canvasTapHandler.ignoreGestures(!0),this._toolTapHandler.ignoreGestures(!0)),e.stopPropagation(),e.preventDefault()},_toolEnd:function(e){if(e){var t=e.target.dataset.tool;
"LI"==e.target.tagName&&t&&("pan"==t||"eraser"==t||"pencil"==t)&&(this._settings.tools.gesture=null,this._setActiveTool(),this._canvasTapHandler.ignoreGestures(!1),this._toolTapHandler.ignoreGestures(!1))}},_toolChanged:function(e){var i=n.parentEleWithClassname(e.target,"toolitem");if(i&&"LI"==i.tagName){var s=i.dataset.action,o=i.dataset.tool;o?("pencil"==o?this._settings.tools.point="pencil":"eraser"==o?this._settings.tools.point="eraser":"pan"==o?t.isComputer()?this._settings.tools.scroll="pan":this._settings.tools.point="pan":"zoom"==o&&(this._settings.tools.scroll="zoom"),this._setActiveTool(),this._saveSettings()):s&&("undo"==s?this._undo():"redo"==s&&this._redo(),"color"==s&&(this._showModal("colorPicker"),e.preventDefault(),e.stopImmediatePropagation()))}},_setActiveTool:function(){function e(e){var t=i.dataset["active"+e];if(t){var n=document.getElementById(t);n.classList.remove("active-"+e)}var s=this._settings.tools[e];if(s){var o=s+"-tool",r=document.getElementById(o);r.classList.add("active-"+e),i.dataset["active"+e]=o}else delete i.dataset["active"+e]}var i=document.getElementById("tools");e=e.bind(this),e("point"),t.isComputer()&&e("scroll")},_keyDown:function(e){var i=String.fromCharCode(e.keyCode);t.isMac()&&e.metaKey&&e.shiftKey&&"Z"==i||t.isPC()&&e.ctrlKey&&"Y"==i?this._redo():(t.isMac()&&e.metaKey||t.isPC()&&e.ctrlKey)&&"Z"==i?(e.preventDefault(),this._undo()):"Z"==i?(this._settings.tools.scroll="zoom",this._setActiveTool()):"P"==i&&(this._settings.tools.scroll="pan",this._setActiveTool())},_undo:function(){this._file.undo(),this._updateAll=!0},_redo:function(){this._file.redo(),this._updateAll=!0},_fileNameKeyDown:function(e){13==e.keyCode&&this._fileNameElement.blur()},_fileNameBlur:function(e){var t=e.target.value;this._file.rename(t)},_saveSettings:function(){this._saveSettingsTimeout&&clearTimeout(this._saveSettingsTimeout),this._saveSettingsTimeout=setTimeout(function(){this._file.localSettings(this._settings)}.bind(this),100)},_fileModifiedRemotely:function(e){this._file.fileInfoPromise.then(function(t){e.id==t.id&&(this._updateAll=!0)}.bind(this))},_fileRenamed:function(e){this._file.fileInfoPromise.then(function(t){t.id==e.id&&(this._fileNameElement.value=e.name)}.bind(this))},_onlineStatusChanged:function(e){e.online&&this._file.isConnected()&&this._file.sync(null,!0).then(function(){this._scheduleUpdate()}.bind(this)).catch(function(e){console.error(e,e.stack,e.message)})},_scheduleUpdate:function(){this._fileSyncTimeout&&clearTimeout(this._fileSyncTimeout),this._fileSyncTimeout=setTimeout(function(){return this._visible?this._currentAction?(console.log("We are currently drawing, delaying sync"),this._scheduleUpdate(),void 0):(this._file.isConnected()?this._file.sync(null,!1).then(function(){this._scheduleUpdate()}.bind(this)):this._scheduleUpdate(),void 0):void 0}.bind(this),15e3)}});return h}),n("managers/files",["section","event","platform","data","sections/fileList","sections/draw"],function(e,t,i,n,s,o){var r=e.extend({id:"files",_paneWrapper:null,_screenWidth:0,panes:null,currentPaneName:null,_currentState:null,init:function(){this._super(),this._screenWidth=window.innerWidth,this._paneWrapper=document.getElementById("files-pane-wrapper"),this._windowResized=this._windowResized.bind(this),this._finishedSliding=this._finishedSliding.bind(this),this._paneWrapper.addEventListener(i.transitionEnd,this._finishedSliding),this.panes={},this.panes.list={offsetX:0,pane:new s(this)},this.panes.draw={offsetX:this._screenWidth,pane:new o(this)},this.panes.draw.pane.element.style[i.transform]="translate("+this._screenWidth+"px, 0px)",this._currentState={pane:"list",details:null},localStorage.filesPane&&(this._currentState=JSON.parse(localStorage.filesPane));var e=location.hash;0===e.indexOf("#")&&(e=e.slice(1),this._currentState.pane="draw",this._currentState.details={id:e}),t.addListener("fileIdChanged",this._fileIdChanged.bind(this))},show:function(){this.setPane(this._currentState.pane,this._currentState.details),this._redoOffsets(),window.addEventListener("resize",this._windowResized)},hide:function(){window.removeEventListener("resize",this._windowResized)},setPane:function(e,t){if(this.currentPaneName!=e){var n=null;if(this.currentPaneName){var n=this.panes[this.currentPaneName].pane;n.hide&&n.hide(),n.afterHide()}n=this.panes[e].pane,n.show&&n.show(t),n.afterShow(),this.currentPaneName=e;var s=this.panes[e],o="translate("+-1*s.offsetX+"px, 0px)";this._paneWrapper.style[i.transform]!=o&&(this._paneWrapper.classList.add("ani4"),this._paneWrapper.style[i.transform]=o),this._currentState={pane:"list",details:null},"list"!=e&&(this._currentState.pane=e,this._currentState.details=t),localStorage.filesPane=JSON.stringify(this._currentState)}},_finishedSliding:function(e){e.target==this._paneWrapper&&(this._paneWrapper.classList.remove("ani4"),this._redoOffsets())},_windowResized:function(){this._redoOffsets()},_redoOffsets:function(){this._screenWidth=window.innerWidth;var e=0;for(var t in this.panes){if(this.currentPaneName==t)break;e++}var n=-1*e*this._screenWidth;for(var t in this.panes)this.panes[t].offsetX=n,this.panes[t].pane.element.style[i.transform]="translate("+n+"px, 0px)",n+=this._screenWidth;this._paneWrapper.style[i.transform]=""},_fileIdChanged:function(e){this._currentState.details&&this._currentState.details.id==e.newId&&(localStorage.filesPane=JSON.stringify(this._currentState))}});return r}),n("sections/main",["section","event","managers/files"],function(e,t,i){var n=e.extend({id:"main-container",mainContent:null,panes:null,currentPane:"",init:function(){this._super(),this.mainContent=document.getElementById("main-content"),this.panes={},this.panes.files=new i,t.addListener("logout",this._logout.bind(this))},show:function(){localStorage.currentPane?this.setPane(localStorage.currentPane):this.setPane("files")},setPane:function(e){if(this.currentPane!=e){var i=null;if(this.currentPane){var i=this.panes[this.currentPane];i.hide&&i.hide(),i.afterHide()}i=this.panes[e],i.show&&i.show(),i.afterShow(),this.currentPane=e,localStorage.currentPane=e,t.trigger("paneChanged",{pane:i})}},_logout:function(){delete localStorage.currentPane}});return n}),n("managers/login",["event","gauth","sections/login","sections/main"],function(e,t,i,n){function s(){this.init()}return s.prototype={pages:null,currentPage:"",init:function(){this.pages={},e.addListener("authenticatedStatusChanged",this._authenticatedStatusChanged.bind(this)),this.pages.login=new i,this.pages.main=new n,localStorage.loggedIn?this.setPage("main"):this.setPage("login")},setPage:function(e){var t=null;this.currentPage&&(t=this.pages[this.currentPage],t.hide&&t.hide(),t.afterHide()),t=this.pages[e],t.show&&t.show(),t.afterShow(),this.currentPage=e},_authenticatedStatusChanged:function(e){e.authenticated?(localStorage.loggedIn=!0,this.setPage("main")):(localStorage.loggedIn=!1,this.setPage("login"))}},s}),n("sections/updateMessage",["event","section","tapHandler"],function(e,t,i){var n=t.extend({id:"updateBar",init:function(){this._super();var e=document.getElementById("updateBarContent");new i(e,{tap:this._buttonClicked.bind(this)})},show:function(){this.element.classList.add("visible")},hide:function(){this.element.classList.remove("visible")},_buttonClicked:function(){location.reload()}});return new n}),n("cacheHandler",["sections/updateMessage"],function(e){function t(){this.init()}return t.prototype={init:function(){},updateReady:function(){e.show()}},new t}),"interactive"===document.readyState||"complete"===document.readyState?e():document.addEventListener("DOMContentLoaded",e,!1),window.Promise||i(["promise"],function(e){window.Promise=e}),window.gapiLoaded=function(){i(["online"],function(e){e.gapiLoaded()})},window.gapiLoadError=function(){i(["online"],function(e){e.gapiLoadError()})},window.applicationCache.addEventListener("updateready",function(){i(["cacheHandler"],function(e){e.updateReady()})}),n("main",function(){})}();